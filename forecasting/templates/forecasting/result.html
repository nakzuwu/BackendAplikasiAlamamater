    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Hasil Peramalan Jas Almamater</title>

        <!-- Bootstrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

        <style>
            :root {
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-card: #21262d;
                --text-primary: #f0f6fc;
                --text-secondary: #8b949e;
                --accent-primary: #58a6ff;
                --accent-secondary: #1f6feb;
                --border-color: #30363d;
                --success: #3fb950;
                --warning: #d29922;
                --danger: #f85149;
            }

            body {
                background-color: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
                transition: all 0.3s ease;
            }

            .container {
                max-width: 1400px;
                margin-top: 40px;
                margin-bottom: 60px;
            }

            .card {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            }

            .table {
                color: var(--text-primary);
                border-color: var(--border-color);
            }

            .table th {
                background-color: var(--accent-secondary);
                color: white;
                text-align: center;
                vertical-align: middle;
                font-weight: 600;
                border: none;
                padding: 12px 8px;
            }

            .table td {
                text-align: center;
                vertical-align: middle;
                padding: 12px 8px;
                border-color: var(--border-color);
            }

            .table-striped tbody tr:nth-of-type(odd) {
                background-color: rgba(255, 255, 255, 0.03);
            }

            .table-striped tbody tr:nth-of-type(even) {
                background-color: rgba(255, 255, 255, 0.06);
            }

            .table-striped tbody tr:hover {
                background-color: rgba(88, 166, 255, 0.1);
            }

            .btn-primary {
                background-color: var(--accent-primary);
                border-color: var(--accent-primary);
                color: white;
                font-weight: 500;
                padding: 10px 20px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                background-color: var(--accent-secondary);
                border-color: var(--accent-secondary);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
            }

            .btn-secondary {
                background-color: var(--bg-secondary);
                border-color: var(--border-color);
                color: var(--text-primary);
                padding: 10px 20px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .btn-secondary:hover {
                background-color: var(--border-color);
                border-color: var(--text-secondary);
                transform: translateY(-2px);
            }

            .alert-danger {
                background-color: rgba(248, 81, 73, 0.15);
                border-color: var(--danger);
                color: var(--danger);
                border-radius: 8px;
            }

            h1, h2, h3, h4, h5, h6 {
                color: var(--text-primary);
                font-weight: 600;
            }

            .text-primary {
                color: var(--accent-primary) !important;
            }

            .text-secondary {
                color: var(--text-secondary) !important;
            }

            .text-muted {
                color: var(--text-secondary) !important;
            }

            #multiChart, #yearlyChart {
                width: 100% !important;
                min-height: 350px;
                max-height: 500px;
            }

            .header-icon {
                font-size: 1.8rem;
                margin-right: 10px;
                vertical-align: middle;
            }

            .metric-highlight {
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                color: white;
                padding: 4px 10px;
                border-radius: 6px;
                font-weight: 600;
            }

            .metric-container {
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 25px;
            }

            .metric-card {
                flex: 1;
                min-width: 200px;
                background-color: var(--bg-secondary);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
                border-left: 4px solid var(--accent-primary);
            }

            .metric-value {
                font-size: 1.8rem;
                font-weight: 700;
                margin: 10px 0;
                color: var(--accent-primary);
            }

            .metric-label {
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .footer {
                margin-top: 40px;
                padding: 20px 0;
                text-align: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
                border-top: 1px solid var(--border-color);
            }

            .theme-toggle {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 1000;
                transition: all 0.3s ease;
            }

            .theme-toggle:hover {
                transform: rotate(15deg);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .calculation-card {
                background: var(--bg-secondary);
                border-left: 4px solid var(--accent-primary);
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
            }

            .formula {
                font-family: "Courier New", monospace;
                background: var(--bg-primary);
                padding: 12px;
                border-radius: 6px;
                margin: 8px 0;
                border: 1px solid var(--border-color);
                color: var(--accent-primary);
                font-weight: 500;
            }

            .calculation-step {
                background: var(--bg-secondary);
                padding: 10px;
                border-radius: 6px;
                margin: 5px 0;
                border-left: 3px solid var(--success);
            }

            .btn-info {
                background-color: #17a2b8;
                border-color: #17a2b8;
                color: white;
            }

            .btn-info:hover {
                background-color: #138496;
                border-color: #117a8b;
            }

            .method-badge {
                font-size: 0.8rem;
                padding: 4px 8px;
            }

            .best-metric {
                background: linear-gradient(135deg, var(--success), #2ea043);
                color: white;
                font-weight: bold;
                padding: 2px 8px;
                border-radius: 4px;
            }

            @media (max-width: 768px) {
                .container {
                    margin-top: 70px;
                }

                .table-responsive {
                    font-size: 0.85rem;
                }

                .metric-card {
                    min-width: 100%;
                }
            }
            /* Tambahkan di bagian style */
            .btn-danger {
                background: linear-gradient(135deg, #dc3545, #c82333);
                border: none;
                padding: 12px 30px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-danger:hover {
                background: linear-gradient(135deg, #c82333, #bd2130);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            }

            /* Loading state */
            .btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
        </style>
    </head>

    <body>
        <div class="container">
            {% if error %}
            <div class="alert alert-danger text-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
            </div>
            <div class="text-center">
                <a href="/" class="btn btn-secondary mt-3">
                    <i class="bi bi-arrow-left me-2"></i>Kembali
                </a>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
    <i class="bi bi-sliders me-2"></i>
    <strong>Presisi Alpha:</strong> 
    {% if alpha_step == 0.01 %}
        Menggunakan Alpha Step 0.01 (99 kombinasi alpha)
    {% else %}
        Menggunakan Alpha Step 0.1 (9 kombinasi alpha)
    {% endif %}
    | 
    <strong>Total Perhitungan:</strong> {{ total_calculations }} kombinasi
</div>

            <div class="text-center mb-5">
                <h1 class="fw-bold text-primary mb-3">
                    <i class="bi bi-graph-up header-icon"></i>Hasil Peramalan Jas Almamater
                </h1>
                <p class="text-muted fs-5">
                    Analisis Prediksi Berdasarkan Multiple Metode Evaluasi
                </p>
            </div>

<!-- Metrics Summary -->
<div class="metric-container">
    <div class="metric-card">
        <div class="metric-label">Total Ukuran</div>
        <div class="metric-value">{{ results|length }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">MAPE Terbaik</div>
        <div class="metric-value">{{ best_mape|floatformat:1 }}%</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">MAE Terbaik</div>
        <div class="metric-value">
            {% with best_mae=results|dictsort:"mae"|first %}
                {{ best_mae.mae|floatformat:0 }}
            {% endwith %}
        </div>
    </div>
    <div class="metric-card">
    <div class="metric-label">Alpha Step</div>
    <div class="metric-value">
        {% if alpha_step == 0.01 %}
            0.01 (99)
        {% else %}
            0.1 (9)
        {% endif %}
    </div>
</div>
    <div class="metric-card">
        <div class="metric-label">MSE Terbaik</div>
        <div class="metric-value">
            {% with best_mse=results|dictsort:"mse"|first %}
                {{ best_mse.mse|floatformat:0 }}
            {% endwith %}
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Tahun Prediksi</div>
        <div class="metric-value">{{ results.0.tahun_next }}</div>
    </div>
</div>

<!-- 1. Table Hasil Prediksi menggunakan MAPE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MAPE Terbaik
    </h4>
    <div class="alert alert-success mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MAPE (Mean Absolute Percentage Error):</strong> Metode terbaik berdasarkan error persentase terkecil. 
        MAPE < 10% = Akurasi Tinggi, 10-20% = Baik, >20% = Perlu Perbaikan
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <!-- <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th> -->
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <!-- <th>Trend</th> -->
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha_mape|floatformat:2 }}
        {% else %}
            {{ r.alpha_mape|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>
                        <span class="best-metric">{{ r.mape|floatformat:1 }}%</span>
                    </td>
                    <td>{{ r.mae|floatformat:0 }}</td>
                    <td>{{ r.mse|floatformat:0 }}</td>
                    <!-- <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td> -->
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-warning bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <!-- <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td> -->
                    <td>
                    <button class="btn btn-sm btn-outline-info" 
                            onclick='showAllCalculations(
                                "{{ r.ukuran }}", 
                                {{ r.alpha_mape }},
                                {{ r.actual_last }}, 
                                {{ r.forecast_last|default:0 }}, 
                                {{ r.forecast_next }}, 
                                {{ r.mape }},
                                {{ r.mae }},
                                {{ r.mse }},
                                "MAPE",
                                {{ r.yearly_calculations_json|default:"[]"|safe }},
                                {{ r.yearly_metrics_json|default:"[]"|safe }},
                                {{ r.all_alpha_data_json|default:"[]"|safe }},
                                {{ alpha_step }}
                            )'>
                        <i class="bi bi-calculator me-1"></i>Lihat Detail
                    </button>

                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 2. Table Hasil Prediksi menggunakan MAE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MAE Terbaik
    </h4>
    <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MAE (Mean Absolute Error):</strong> Metode terbaik berdasarkan error absolut terkecil. 
        Semakin kecil MAE semakin akurat prediksi dalam satuan asli data.
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <!-- <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th> -->
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <!-- <th>Trend</th> -->
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in mae_best_results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha|floatformat:2 }}
        {% else %}
            {{ r.alpha|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>{{ r.mape|floatformat:1 }}%</td>
                    <td>
                        <span class="best-metric">{{ r.mae|floatformat:0 }}</span>
                    </td>
                    <td>{{ r.mse|floatformat:0 }}</td>
                    <!-- <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td> -->
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-info bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <!-- <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td> -->
                    <td>
<button class="btn btn-sm btn-outline-info" 
        onclick='showAllCalculations(
            "{{ r.ukuran }}", 
            {{ r.alpha_mae }}, 
            {{ r.actual_last }}, 
            {{ r.forecast_last|default:0 }}, 
            {{ r.forecast_next }}, 
            {{ r.mape }},
            {{ r.mae }},
            {{ r.mse }},
            "MAE",
            {{ r.yearly_calculations_json|default:"[]"|safe }},
            {{ r.yearly_metrics_json|default:"[]"|safe }},
            {{ r.all_alpha_data_json|default:"[]"|safe }},
            {{ alpha_step }}
        )'>
    <i class="bi bi-calculator me-1"></i>Lihat Detail
</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 3. Table Hasil Prediksi menggunakan MSE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MSE Terbaik
    </h4>
    <div class="alert alert-warning mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MSE (Mean Squared Error):</strong> Metode terbaik berdasarkan error kuadrat terkecil. 
        Lebih sensitif terhadap outlier, memberikan penalti lebih besar untuk error yang besar.
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <!-- <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th> -->
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <!-- <th>Trend</th> -->
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in mse_best_results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha|floatformat:2 }}
        {% else %}
            {{ r.alpha|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>{{ r.mape|floatformat:2 }}%</td>
                    <td>{{ r.mae|floatformat:0 }}</td>
                    <td>
                        <span class="best-metric">{{ r.mse|floatformat:0 }}</span>
                    </td>
                    <!-- <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td> -->
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-warning bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <!-- <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td> -->
                    <td>
<button class="btn btn-sm btn-outline-info" 
        onclick='showAllCalculations(
            "{{ r.ukuran }}", 
            {{ r.alpha_mse }}, 
            {{ r.actual_last }}, 
            {{ r.forecast_last|default:0 }}, 
            {{ r.forecast_next }}, 
            {{ r.mape }},
            {{ r.mae }},
            {{ r.mse }},
            "MSE",
            {{ r.yearly_calculations_json|default:"[]"|safe }},
            {{ r.yearly_metrics_json|default:"[]"|safe }},
            {{ r.all_alpha_data_json|default:"[]"|safe }},
            {{ alpha_step }}
        )'>
    <i class="bi bi-calculator me-1"></i>Lihat Detail
</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card p-4 mb-5">
 <div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-bar-chart header-icon"></i>Perbandingan Semua Alpha 
        <span class="badge bg-info ms-2">
            {% if alpha_step == 0.01 %}Step 0.01{% else %}Step 0.1{% endif %}
        </span>
    </h4>

    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Total Perhitungan:</strong> {{ total_calculations }} kombinasi 
        ({% if alpha_step == 0.01 %}99{% else %}9{% endif %} alpha Ã— {{ results|length }} ukuran)
    </div>

    {% for ukuran, calculations in all_calculations.items %}
    <div class="mb-4">
        <h5 class="text-primary mb-3">
            <i class="bi bi-graph-up"></i> Ukuran: {{ ukuran }}
            <span class="badge bg-secondary">
                {% if alpha_step == 0.01 %}99{% else %}9{% endif %} Kombinasi Alpha
            </span>
        </h5>

        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr class="table-dark">
                        <th>Alpha (Î±)</th>
                        <th>MAPE (%)</th>
                        <th>MAE</th>
                        <th>MSE</th>
                        <th>Keterangan</th>
                        <th>Forecast (F<sub>t+1</sub>)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for calc in calculations %}
                    <tr>
                        <td>
                            <strong>
                                {% if alpha_step == 0.01 %}
                                    {{ calc.alpha|floatformat:2 }}
                                {% else %}
                                    {{ calc.alpha|floatformat:1 }}
                                {% endif %}
                            </strong>
                        </td>
                        <td>
                            {{ calc.mape|floatformat:1 }}%
                            {% if calc.is_best_mape %}
                                <span class="badge bg-success">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ calc.mae|floatformat:0 }}
                            {% if calc.is_best_mae %}
                                <span class="badge bg-info">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ calc.mse|floatformat:0 }}
                            {% if calc.is_best_mse %}
                                <span class="badge bg-warning">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if calc.is_best_mape %}
                                <span class="badge bg-success">MAPE Terbaik</span>
                            {% endif %}
                            {% if calc.is_best_mae %}
                                <span class="badge bg-info">MAE Terbaik</span>
                            {% endif %}
                            {% if calc.is_best_mse %}
                                <span class="badge bg-warning">MSE Terbaik</span>
                            {% endif %}
                        </td>
                        <td class="fw-bold">
                            {{ calc.forecast_next|floatformat:0 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Tambahkan informasi alpha terbaik untuk ukuran ini -->
        {% with result=results|first %}
            {% if result.ukuran == ukuran %}
                <div class="alert alert-light mt-2">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Alpha terbaik untuk {{ ukuran }}:</strong><br>
                        â€¢ MAPE Terbaik: Alpha {{ result.alpha_mape|floatformat:2 }} = {{ result.mape|floatformat:1 }}%<br>
                        â€¢ MAE Terbaik: Alpha {{ result.alpha_mae|floatformat:2 }} = {{ result.mae|floatformat:0 }}<br>
                        â€¢ MSE Terbaik: Alpha {{ result.alpha_mse|floatformat:2 }} = {{ result.mse|floatformat:0 }}
                    </small>
                </div>
            {% endif %}
        {% endwith %}
    </div>
    {% endfor %}
</div>
            <!-- 5. Semua Rumus Perhitungan -->
            <div class="card p-4 mb-5">
                <h4 class="text-secondary mb-4 text-center">
                    <i class="bi bi-calculator header-icon"></i>Rumus Perhitungan Lengkap
                </h4>

                <div class="row">
                    <!-- Metode Exponential Smoothing -->
                    <div class="col-md-6 mb-4">
                        <div class="calculation-card">
                            <h5 class="text-primary">Metode: Single Exponential Smoothing</h5>
                            <p class="text-muted">
                                Metode pembobotan eksponensial untuk data time series
                            </p>

                            <div class="calculation-card">
                                <strong>Rumus Exponential Smoothing:</strong>
                                <div class="formula">
                                    F<sub>t</sub> = Î± Ã— A<sub>t-1</sub> + (1-Î±) Ã— F<sub>t-1</sub>
                                </div>
                                <small class="text-muted">Dimana: F<sub>t</sub> = Forecast periode t, A<sub>t-1</sub> = Actual periode t-1, Î± = Alpha (konstanta smoothing 0.1-0.9)</small>
                            </div>

                            <div class="calculation-card">
                                <strong>Rumus Forecast Tahun Berikutnya:</strong>
                                <div class="formula">
                                    F<sub>t+1</sub> = Î± Ã— A<sub>t</sub> + (1-Î±) Ã— F<sub>t</sub>
                                </div>
                                <small class="text-muted">Forecast untuk tahun berikutnya menggunakan data aktual terakhir dan forecast terakhir</small>
                            </div>
                        </div>
                    </div>

                    <!-- Metode Evaluasi -->
                    <div class="col-md-6 mb-4">
                        <div class="calculation-card">
                            <h5 class="text-primary">Metode Evaluasi Akurasi</h5>
                            
                            <div class="calculation-card">
                                <strong>MAPE (Mean Absolute Percentage Error):</strong>
                                <div class="formula">
                                    MAPE = (1/n) Ã— Î£ |(A<sub>t</sub> - F<sub>t</sub>) / A<sub>t</sub>| Ã— 100%
                                </div>
                                <small class="text-muted">Mengukur error dalam persentase relatif. < 10% = Excellent</small>
                            </div>

                            <div class="calculation-card">
                                <strong>MAE (Mean Absolute Error):</strong>
                                <div class="formula">
                                    MAE = (1/n) Ã— Î£ |A<sub>t</sub> - F<sub>t</sub>|
                                </div>
                                <small class="text-muted">Mengukur error absolut dalam satuan data asli</small>
                            </div>

                            <div class="calculation-card">
                                <strong>MSE (Mean Squared Error):</strong>
                                <div class="formula">
                                    MSE = (1/n) Ã— Î£ (A<sub>t</sub> - F<sub>t</sub>)Â²
                                </div>
                                <small class="text-muted">Mengukur error kuadrat, sensitif terhadap outlier</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Grafik -->
            <div class="card p-4 mb-5">
                <h4 class="text-secondary text-center mb-4">
                    <i class="bi bi-graph-up-arrow header-icon"></i>Grafik Perbandingan Hasil Forecasting
                </h4>
                <canvas id="multiChart"></canvas>
            </div>
            <div class="card p-4 mb-5">
                <h4 class="text-secondary text-center mb-4">
                    <i class="bi bi-bar-chart-fill header-icon"></i>Grafik Perbandingan per Tahun (%)
                </h4>
                <div style="height: 400px; position: relative;"> <!-- Container dengan tinggi tetap -->
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
            <!-- Tambahkan tombol ini di bagian sebelum tombol "Kembali ke Halaman Awal" -->
            <!-- Ganti bagian tombol di akhir halaman dengan ini -->
            <div class="text-center">
                <div class="mb-4">
                    <button id="downloadPdf" class="btn btn-danger me-3">
                        <i class="bi bi-file-pdf me-2"></i>Download PDF Report
                    </button>
                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Kembali ke Halaman Awal
                    </a>
                </div>
            </div>

            {% endif %}

<!-- Modal untuk Detail Perhitungan -->
<div class="modal fade" id="calculationModal" tabindex="-1" 
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #ffffff; color: #212529;">
            <div class="modal-header" style="background-color: #0d6efd; color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-calculator me-2"></i>Detail Perhitungan Forecasting
                </h5>
                <button type="button" class="btn-close btn-close-white" 
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="calculationDetails" 
                 style="background-color: #ffffff; color: #212529; max-height: 70vh; overflow-y: auto;">
                <!-- Detail perhitungan akan dimuat di sini -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Memuat data perhitungan...</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Tutup
                </button>
            </div>
        </div>
    </div>
</div>

            <div class="footer">
                <p>
                    &copy; 2023 Sistem Peramalan Jas Almamater | Analisis Multiple Metode
                </p>
            </div>
        </div>

        <!-- Chart.js script -->
        <script>
// GLOBAL VARIABLES - MUST BE DECLARED FIRST!
// ============================================================================
let currentModal = null;

// ============================================================================
// HELPER FUNCTIONS - GLOBAL SCOPE (accessible from onclick)
// ============================================================================
function formatNumber(num, decimals = 0) {
    if (num === undefined || num === null || isNaN(num)) return '0';
    const multiplier = Math.pow(10, decimals);
    const rounded = Math.round(num * multiplier) / multiplier;
    
    if (decimals === 0) {
        return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    const parts = rounded.toString().split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(',');
}

function roundNumber(num, decimals = 2) {
    if (num === undefined || num === null) return 0;
    return parseFloat(num.toFixed(decimals));
}

function formatAlphaDisplay(alpha, alphaStep = 0.1) {
    if (alpha === undefined || alpha === null) return '0.00';
    const num = parseFloat(alpha);
    
    if (alphaStep === 0.01) {
        const rounded = Math.round(num * 100) / 100;
        return rounded.toFixed(2);
    } else {
        const rounded = Math.round(num * 10) / 10;
        return rounded.toFixed(1);
    }
}
function roundNumber(value, decimals = 2) {
    if (value === null || value === undefined || isNaN(value)) return value;
    return Number(Math.round((Number(value) + Number.EPSILON) * 10 ** decimals) / 10 ** decimals);
}

function formatFixed(value, decimals = 2) {
    const num = Number(value);
    if (isNaN(num)) return value;
    return roundNumber(num, decimals).toFixed(decimals);
}


// ============================================================================
// MAIN MODAL FUNCTION - GLOBAL SCOPE (accessible from onclick)
// ============================================================================
function showAllCalculations(ukuran, alpha, actualLast, forecastLast, forecastNext, 
                            mape, mae, mse, metricType, 
                            yearlyCalculationsJson, yearlyMetricsJson, allAlphasDataJson, alphaStep = 0.1) {
    
    // ==================== STEP 1: PREPARE MODAL ====================
    // Pastikan modal utama dihapus jika ada duplikat
    const existingModal = document.getElementById('calculationModal');
    if (existingModal) {
        // Coba tutup modal yang aktif
        const bsModal = bootstrap.Modal.getInstance(existingModal);
        if (bsModal) {
            bsModal.hide();
            bsModal.dispose();
        }
        
        // Hapus dari DOM setelah delay singkat
        setTimeout(() => {
            if (existingModal.parentNode) {
                existingModal.remove();
            }
        }, 100);
    }
    
    // Hapus semua backdrop yang mungkin tersisa
    setTimeout(() => {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }, 50);
    
    // ==================== STEP 2: PARSE DATA ====================
    let yearlyCalculations = [];
    let yearlyMetrics = [];
    let allAlphasData = [];
    
    try {
        yearlyCalculations = typeof yearlyCalculationsJson === 'string' 
            ? JSON.parse(yearlyCalculationsJson) 
            : (yearlyCalculationsJson || []);
        
        yearlyMetrics = typeof yearlyMetricsJson === 'string' 
            ? JSON.parse(yearlyMetricsJson) 
            : (yearlyMetricsJson || []);
        
        allAlphasData = typeof allAlphasDataJson === 'string' 
            ? JSON.parse(allAlphasDataJson) 
            : (allAlphasDataJson || []);
    } catch (error) {
        console.error('JSON parse error:', error);
        alert('Error loading calculation details.');
        return;
    }
    
    // Validasi parameter
    alpha = roundNumber(alpha || 0, 2);
    actualLast = roundNumber(actualLast || 0);
    forecastLast = roundNumber(forecastLast || 0);
    forecastNext = roundNumber(forecastNext || 0);
    mape = roundNumber(mape || 0);
    mae = roundNumber(mae || 0);
    mse = roundNumber(mse || 0);
    metricType = metricType || 'MAPE';
    alphaStep = alphaStep || 0.1;
    
    const alphaDisplay = formatAlphaDisplay(alpha, alphaStep);
    
    // ==================== STEP 3: BUILD HTML CONTENT ====================
    const cardStyle = "background: #f8f9fa; border-left: 4px solid #58a6ff; padding: 15px; margin: 10px 0; border-radius: 8px; color: #212529;";
    const tableHeaderStyle = "background-color: #198754; color: white;";
    const textInfoStyle = "color: #0dcaf0 !important;";
    const textWarningStyle = "color: #ffc107 !important;";
    const textDangerStyle = "color: #dc3545 !important;";
    
    let html = `
        <div style="${cardStyle}">
            <h6 style="color: #0d6efd;">ðŸ“Š Detail Perhitungan Lengkap - ${metricType} Terbaik</h6>
            <p style="color: #6c757d;">
                Ukuran: <strong style="color: #212529;">${ukuran}</strong> | 
                Alpha Terbaik: <strong style="color: #212529;">${alphaDisplay}</strong> | 
                Tahun Berikutnya: <strong style="color: #212529;">${formatNumber(forecastNext)}</strong>
            </p>
        </div>
    `;

    // Alpha comparison table
    if (allAlphasData && allAlphasData.length > 0) {
        const totalAlphas = allAlphasData.length;
        const alphaCountInfo = totalAlphas >= 99 ? "99 kombinasi alpha" : `${totalAlphas} kombinasi alpha`;
        
        html += `
            <div style="${cardStyle}">
                <h6 style="color: #198754;">ðŸ“ˆ Perbandingan Alpha</h6>
                <div class="alert alert-info" style="background-color: #cff4fc; border-color: #b6effb; color: #055160;">
                    <i class="bi bi-info-circle me-2"></i>
                    Total <strong>${alphaCountInfo}</strong> diuji untuk mendapatkan nilai optimal
                </div>
                <div class="table-responsive mt-2" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead style="${tableHeaderStyle}" class="sticky-top">
                            <tr>
                                <th>No</th>
                                <th>Alpha (Î±)</th>
                                <th>MAPE (%)</th>
                                <th>MAE</th>
                                <th>MSE</th>
                                <th>Forecast</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        const sortedAlphas = [...allAlphasData].sort((a, b) => b.alpha - a.alpha);
        
        sortedAlphas.forEach((calc, index) => {
            const isBest = Math.abs(calc.alpha - alpha) < 0.001;
            const alphaDisplayCalc = formatAlphaDisplay(calc.alpha, alphaStep);
            const mapeValue = roundNumber(calc.mape || 0);
            const mapeClass = mapeValue < 10 ? 'text-success' : mapeValue < 20 ? 'text-warning' : 'text-danger';
            
            html += `
                <tr ${isBest ? 'style="background-color: #fff3cd;"' : ''}>
                    <td>${index + 1}</td>
                    <td><strong>${alphaDisplayCalc}</strong></td>
                    <td class="${mapeClass}">${formatNumber(mapeValue)}%</td>
                    <td>${formatNumber(calc.mae || 0)}</td>
                    <td>${formatNumber(calc.mse || 0)}</td>
                    <td>${formatNumber(calc.forecast_next || 0)}</td>
                    <td>${isBest ? '<span class="badge bg-success">TERBAIK</span>' : ''}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

// Yearly calculations - MODIFIKASI: Tambahkan pembulatan 2 angka tanpa .00
if (yearlyCalculations && yearlyCalculations.length > 0) {
    html += `
        <div style="${cardStyle}">
            <h6 style="color: #ffc107;">ðŸ“‹ Detail Perhitungan Forecast dengan Alpha ${alphaDisplay}</h6>
            <div class="alert alert-warning" style="background-color: #fff3cd; border-color: #ffecb5; color: #664d03;">
                <i class="bi bi-calculator me-2"></i>
                <strong>Rumus:</strong> F<sub>t</sub> = Î± Ã— A<sub>t-1</sub> + (1-Î±) Ã— F<sub>t-1</sub>
            </div>
            <div class="table-responsive mt-2">
                <table class="table table-sm table-bordered" style="color: #212529;">
                    <thead style="background-color: #ffc107; color: #212529;">
                        <tr>
                            <th>Tahun</th>
                            <th>Aktual</th>
                            <th>Forecast</th>
                            <th>Perhitungan</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    yearlyCalculations.forEach(calc => {
        // Format perhitungan dengan pembulatan 2 angka tanpa .00 jika tidak perlu
        let calculationDisplay = '-';
        
        if (calc.calculation) {
            let str = String(calc.calculation);
            
            // Helper function untuk format angka tanpa .00
            const formatNumberClean = (numStr) => {
                const num = parseFloat(numStr);
                if (isNaN(num)) return numStr;
                
                // Jika angka sudah bulat, kembalikan tanpa desimal
                if (num === Math.floor(num)) {
                    return num.toString();
                }
                
                // Jika ada .00, .0, dll, hapus trailing zeros
                const rounded = Math.round(num * 100) / 100;
                const str = rounded.toFixed(2);
                
                // Hapus trailing zeros
                if (str.endsWith('.00')) {
                    return str.slice(0, -3);
                } else if (str.endsWith('0')) {
                    return str.slice(0, -1);
                }
                return str;
            };
            
            // Ambil semua angka dalam string
            const numbers = str.match(/-?\d+(\.\d+)?/g);
            
            if (numbers) {
                // Urutkan dari yang terpanjang ke terpendek untuk menghindari partial replacement
                const sortedNumbers = [...numbers].sort((a, b) => b.length - a.length);
                
                sortedNumbers.forEach(num => {
                    const formatted = formatNumberClean(num);
                    // Gunakan regex dengan word boundaries untuk replacement yang tepat
                    const regex = new RegExp(`\\b${num.replace('.', '\\.')}\\b`, 'g');
                    str = str.replace(regex, formatted);
                });
            }
            
            calculationDisplay = str;
        }
        
        html += `
            <tr>
                <td><strong>${calc.tahun || '-'}</strong></td>
                <td>${formatNumber(calc.actual, 0)}</td>
                <td>${formatNumber(calc.forecast, 2, true)}</td> <!-- true untuk clean format -->
                <td><small style="font-family: 'Courier New', monospace;">${calculationDisplay}</small></td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

    // Yearly metrics - MODIFIKASI: Tambahkan pembulatan 2 angka
    if (yearlyMetrics && yearlyMetrics.length > 0) {
        html += `
            <div style="${cardStyle}">
                <h6 style="color: #0dcaf0;">ðŸ“Š Detail Perhitungan ${metricType}</h6>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-bordered" style="color: #212529;">
                        <thead style="background-color: #0dcaf0; color: #212529;">
                            <tr>
                                <th>Tahun</th>
                                <th>Aktual</th>
                                <th>Forecast</th>
                                <th>Error</th>
                                <th>Abs Error</th>
                                <th>Sq Error</th>
                                <th>% Error</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        yearlyMetrics.forEach(metric => {
            const error = roundNumber((metric.actual || 0) - (metric.forecast || 0), 2);
            
            html += `
                <tr>
                    <td><strong>${metric.tahun || '-'}</strong></td>
                    <td>${formatNumber(metric.actual, 2)}</td>
                    <td>${formatNumber(metric.forecast, 2)}</td>
                    <td>${formatNumber(error, 2)}</td>
                    <td style="${textInfoStyle}">${formatNumber(metric.absolute_error, 2)}</td>
                    <td style="${textWarningStyle}">${formatNumber(metric.squared_error, 2)}</td>
                    <td style="${textDangerStyle}">${formatNumber(metric.percentage_error, 2)}%</td>
                </tr>
            `;
        });

        // MODIFIKASI: Bulatkan nilai rata-rata ke 2 desimal
        html += `
                            <tr style="background-color: #d1e7dd; font-weight: bold;">
                                <td colspan="4" style="text-align: end;">RATA-RATA â†’</td>
                                <td style="${textInfoStyle}">${formatNumber(mae, 2)}<br><small>MAE</small></td>
                                <td style="${textWarningStyle}">${formatNumber(mse, 2)}<br><small>MSE</small></td>
                                <td style="${textDangerStyle}">${formatNumber(mape, 2)}%<br><small>MAPE</small></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Conclusion
    let badgeStyle = 'background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;';
    let metricName = 'MAPE (Mean Absolute Percentage Error)';
    
    if (metricType === 'MAE') {
        badgeStyle = 'background-color: #cff4fc; border-color: #b6effb; color: #055160;';
        metricName = 'MAE (Mean Absolute Error)';
    } else if (metricType === 'MSE') {
        badgeStyle = 'background-color: #fff3cd; border-color: #ffecb5; color: #664d03;';
        metricName = 'MSE (Mean Squared Error)';
    }
        // 4. PERHITUNGAN FORECAST TAHUN BERIKUTNYA
    // Hitung dengan pembulatan 2 desimal
    const roundedAlpha = roundNumber(alpha, 2);
    const textSuccessStyle = "color: #198754 !important;";
     const stepStyle = "background: #e9ecef; padding: 10px; border-radius: 6px; margin: 5px 0; border-left: 3px solid #3fb950; color: #212529;";
    const roundedOneMinusAlpha = roundNumber(1 - alpha, 2);
    const part1 = roundNumber(alpha * actualLast, 2);
    const part2 = roundNumber((1 - alpha) * forecastLast, 2);
    const calculatedForecast = roundNumber(part1 + part2, 2);
    
    html += `
        <div style="${cardStyle}">
            <h6 style="${textSuccessStyle}">ðŸ”® Perhitungan Forecast Tahun Berikutnya</h6>
            <div style="${stepStyle}">
                <strong>Rumus:</strong> F<sub>t+1</sub> = Î± Ã— A<sub>t</sub> + (1-Î±) Ã— F<sub>t</sub>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <div style="${stepStyle}">
                        <strong>Nilai Variabel:</strong><br>
                        <table class="table table-sm">
                            <tr><td>Alpha (Î±)</td><td><strong>= ${roundedAlpha}</strong></td></tr>
                            <tr><td>1 - Î±</td><td><strong>= ${roundedOneMinusAlpha}</strong></td></tr>
                            <tr><td>Aktual Terakhir (A<sub>t</sub>)</td><td><strong>= ${formatNumber(actualLast)}</strong></td></tr>
                            <tr><td>Forecast Terakhir (F<sub>t</sub>)</td><td><strong>= ${formatNumber(forecastLast)}</strong></td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="${stepStyle}">
                        <strong>Langkah Perhitungan:</strong><br>
                        1. F<sub>t+1</sub> = ${roundedAlpha} Ã— ${formatNumber(actualLast)} + ${roundedOneMinusAlpha} Ã— ${formatNumber(forecastLast)}<br>
                        2. F<sub>t+1</sub> = ${formatNumber(part1)} + ${formatNumber(part2)}<br>
                        3. F<sub>t+1</sub> = <strong style="${textSuccessStyle}">${formatNumber(calculatedForecast)}</strong>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 5. KESIMPULAN
    let badgeClass = 'success';
    // let badgeStyle = 'background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;';
    // let metricName = '';
    
    if (metricType === 'MAPE') {
        badgeClass = 'success';
        badgeStyle = 'background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;';
        metricName = 'MAPE (Mean Absolute Percentage Error)';
    } else if (metricType === 'MAE') {
        badgeClass = 'info';
        badgeStyle = 'background-color: #cff4fc; border-color: #b6effb; color: #055160;';
        metricName = 'MAE (Mean Absolute Error)';
    } else {
        badgeClass = 'warning';
        badgeStyle = 'background-color: #fff3cd; border-color: #ffecb5; color: #664d03;';
        metricName = 'MSE (Mean Squared Error)';
    }
    
    // Hitung total alpha yang diuji
    const totalAlphaTested = allAlphasData.length;
    
    html += `
        <div class="alert alert-${badgeClass} mt-3" style="${badgeStyle}">
            <i class="bi bi-trophy-fill me-2"></i>
            <strong>Kesimpulan:</strong><br>
            Alpha <strong>${alphaDisplay}</strong> dipilih karena memberikan nilai 
            <strong>${metricType} terkecil</strong> (${metricName}) untuk ukuran ${ukuran}.<br>
            <small>Dari ${totalAlphaTested} kombinasi alpha yang diuji (${allAlphasData.length >= 99 ? '0.01 - 0.99' : 'berbagai nilai alpha'})</small>
        </div>

        <div class="alert alert-success mt-3" style="background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Hasil Prediksi:</strong><br>
            Forecast kebutuhan untuk ukuran ${ukuran} adalah 
            <strong>${formatNumber(forecastNext)} unit</strong>.
        </div>
    `;

    // ==================== STEP 4: UPDATE MODAL CONTENT ====================
    // Gunakan modal yang sudah ada di template, jangan membuat baru
    setTimeout(() => {
        const modalElement = document.getElementById('calculationModal');
        
        // Jika modal tidak ada (sudah dihapus), buat ulang
        if (!modalElement) {
            // Buat modal baru berdasarkan template HTML yang sudah ada
            const newModalHTML = `
                <div class="modal fade" id="calculationModal" tabindex="-1" 
                     data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content" style="background-color: #ffffff; color: #212529;">
                            <div class="modal-header" style="background-color: #0d6efd; color: white;">
                                <h5 class="modal-title">
                                    <i class="bi bi-calculator me-2"></i>Detail Perhitungan Forecasting
                                </h5>
                                <button type="button" class="btn-close btn-close-white" 
                                        data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="calculationDetails" 
                                 style="background-color: #ffffff; color: #212529; max-height: 70vh; overflow-y: auto;">
                            </div>
                            <div class="modal-footer" style="background-color: #f8f9fa;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div');
            container.innerHTML = newModalHTML;
            document.body.appendChild(container.firstElementChild);
        }
        
        // Update konten modal
        const detailsElement = document.getElementById('calculationDetails');
        if (detailsElement) {
            detailsElement.innerHTML = html;
        }
        
        // Tampilkan modal
        const finalModalElement = document.getElementById('calculationModal');
        if (finalModalElement) {
            // Dispose modal yang mungkin masih aktif
            const existingBsModal = bootstrap.Modal.getInstance(finalModalElement);
            if (existingBsModal) {
                existingBsModal.dispose();
            }
            
            // Inisialisasi modal baru
            currentModal = new bootstrap.Modal(finalModalElement, {
                backdrop: 'static',
                keyboard: true,
                focus: true
            });
            
            // Tampilkan modal dengan sedikit delay untuk menghindari blinking
            setTimeout(() => {
                if (currentModal) {
                    currentModal.show();
                }
            }, 100);
            
            // Cleanup saat modal ditutup
            finalModalElement.addEventListener('hidden.bs.modal', function () {
                if (currentModal) {
                    try {
                        currentModal.dispose();
                    } catch (e) {
                        // Ignore errors
                    }
                    currentModal = null;
                }
                
                // Reset body state
                setTimeout(() => {
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 50);
            }, { once: true });
        }
    }, 150); // Delay untuk memastikan cleanup selesai
}
// CHARTS AND OTHER CODE - DOM READY
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Cleanup orphaned modals
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    
    // Charts
    try {
        const actualChartData = {{ actual_chart_data|safe }};
        const forecastChartData = {{ forecast_chart_data|safe }};

        const chartData = {{ chart_data|safe }};
        const years = {{ years|safe }};
        const nextYear = {{ results.0.tahun_next|safe }};
        
        const allYears = [...years, nextYear];
        
        const colors = [
            '#58a6ff', '#3fb950', '#f85149', '#d29922', '#db61a2', '#8b949e'
        ];

        // Line Chart
        // Line Chart - MODIFIKASI: Pisahkan data aktual dan prediksi
// Line Chart - MODIFIKASI: Tambahkan tahun prediksi
const ctxLine = document.getElementById('multiChart').getContext('2d');

// Warna dengan maksimal 6 warna
const lineColors = [
    '#58a6ff', // Biru muda
    '#3fb950', // Hijau
    '#f85149', // Merah
    '#d29922', // Kuning
    '#db61a2', // Pink
    '#8b949e'  // Abu-abu
];


// Buat dataset terpisah untuk aktual vs prediksi
const datasets = [];
let colorIndex = 0;

// Ambil maksimal 6 ukuran pertama
const ukuranKeys = Object.keys(forecastChartData).slice(0, 15);

for (const key of ukuranKeys) {
    const color = lineColors[colorIndex % lineColors.length];

    const actualValues = actualChartData[key] || [];
    const forecastValues = forecastChartData[key] || [];

    // 1ï¸âƒ£ ACTUAL DATA (GARIS SOLID TEBAL) - data historis
    if (actualValues.length > 0) {
        datasets.push({
            label: `${key} - Aktual`,
            data: actualValues,
            borderColor: color,
            backgroundColor: color + '30',
            borderWidth: 3,
            tension: 0.2,
            fill: false,
            pointRadius: 4,
            pointHoverRadius: 7,
            pointBackgroundColor: color
        });
    }

    // 2ï¸âƒ£ FORECAST + PREDIKSI (GARIS PUTUS-PUTUS)
    if (forecastValues.length > 0) {
        // Buat data forecast lengkap termasuk prediksi tahun depan
        // forecastValues sudah berisi data untuk tahun-tahun yang ada + prediksi terakhir
        const forecastWithPrediction = forecastValues; // Sudah termasuk prediksi
        
        datasets.push({
            label: `${key} - Forecast`,
            data: forecastWithPrediction,
            borderColor: color,
            backgroundColor: 'transparent',
            borderWidth: 2,
            tension: 0.2,
            fill: false,
            borderDash: [5, 5],
            pointRadius: function(context) {
                // Titik terakhir (prediksi 2026) lebih besar
                return context.dataIndex === forecastWithPrediction.length - 1 ? 8 : 3;
            },
            pointHoverRadius: function(context) {
                return context.dataIndex === forecastWithPrediction.length - 1 ? 12 : 6;
            },
            pointBackgroundColor: color,
            pointBorderColor: context => context.dataIndex === forecastWithPrediction.length - 1 ? '#ffffff' : color,
            pointBorderWidth: context => context.dataIndex === forecastWithPrediction.length - 1 ? 2 : 0
        });
    }

    colorIndex++;
}

// Plugin untuk custom legend (menyederhanakan label)
const simplifiedLegend = {
    id: 'simplifiedLegend',
    beforeDraw(chart) {
        const legendItems = chart.legend.legendItems;
        if (legendItems) {
            // Sederhanakan label: ubah "XS - Aktual" menjadi "XS"
            legendItems.forEach(item => {
                if (item.text.includes(' - Aktual')) {
                    item.text = item.text.replace(' - Aktual', ' (Aktual)');
                }
                if (item.text.includes(' - Forecast')) {
                    item.text = item.text.replace(' - Forecast', ' (Forecast)');
                }
            });
        }
    }
};

new Chart(ctxLine, {
    type: 'line',
    data: { 
        labels: allYears, // Label tahun termasuk prediksi 2026
        datasets: datasets 
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: `Perbandingan Data Aktual vs Forecast (Termasuk Prediksi ${nextYear})`,
                color: '#f0f6fc',
                font: { size: 16, weight: 'bold' },
                padding: { top: 10, bottom: 20 }
            },
            legend: {
                position: 'bottom',
                labels: {
                    color: '#8b949e',
                    font: { size: 11 },
                    padding: 10,
                    usePointStyle: true,
                    boxWidth: 8,
                    filter: function(legendItem, chartData) {
                        // Tampilkan semua legenda
                        return true;
                    }
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: '#21262d',
                titleColor: '#f0f6fc',
                bodyColor: '#f0f6fc',
                borderColor: '#30363d',
                borderWidth: 1,
                padding: 12,
                callbacks: {
                    title: function(tooltipItems) {
                        const year = allYears[tooltipItems[0].dataIndex];
                        const isPrediction = tooltipItems[0].dataIndex === allYears.length - 1;
                        return isPrediction ? `Prediksi ${year}` : `Tahun ${year}`;
                    },
                    label: function(context) {
                        const label = context.dataset.label;
                        const value = context.parsed.y;
                        if (value === null || value === undefined) return null;

                        const isPredictionYear = context.dataIndex === allYears.length - 1;
                        const sizeName = label.split(' - ')[0];

                        if (label.includes('Aktual')) {
                            return `${sizeName} (Aktual): ${value.toLocaleString('id-ID')} unit`;
                        }
                        if (label.includes('Forecast')) {
                            const suffix = isPredictionYear ? ' (Prediksi)' : ' (Forecast)';
                            return `${sizeName}${suffix}: ${value.toLocaleString('id-ID')} unit`;
                        }

                        return `${label}: ${value.toLocaleString('id-ID')} unit`;
                    },
                    afterBody: function(tooltipItems) {
                        const dataIndex = tooltipItems[0].dataIndex;
                        const isPredictionYear = dataIndex === allYears.length - 1;
                        
                        if (isPredictionYear) {
                            return [
                                '',
                                'ðŸ“Š Keterangan:',
                                `â€¢ Titik besar = Prediksi untuk tahun ${nextYear}`,
                                'â€¢ Garis solid = Data aktual historis',
                                'â€¢ Garis putus-putus = Hasil perhitungan forecast'
                            ];
                        }
                        
                        return [];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Tahun',
                    color: '#8b949e',
                    font: { size: 13, weight: 'bold' }
                },
                grid: { 
                    color: '#30363d',
                    drawOnChartArea: true
                },
                ticks: { 
                    color: '#8b949e',
                    font: { size: 11 },
                    callback: function(value, index) {
                        const year = allYears[index];
                        const isPrediction = index === allYears.length - 1;
                        if (isPrediction) {
                            return [`Prediksi`, year]; // Dua baris untuk prediksi
                        }
                        return year;
                    }
                }
            },
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Jumlah Permintaan (unit)',
                    color: '#8b949e',
                    font: { size: 13, weight: 'bold' }
                },
                grid: { 
                    color: '#30363d',
                    drawBorder: false
                },
                ticks: { 
                    color: '#8b949e',
                    font: { size: 11 },
                    callback: function(value) {
                        return value.toLocaleString('id-ID');
                    }
                }
            }
        },
        elements: {
            point: {
                radius: function(context) {
                    const dataset = context.dataset;
                    const isPredictionPoint = context.dataIndex === context.dataset.data.length - 1;
                    
                    // Jika ini titik prediksi (terakhir) dan dataset forecast
                    if (dataset.label.includes('Forecast') && isPredictionPoint) {
                        return 8; // Titik prediksi lebih besar
                    }
                    return 4; // Titik biasa
                },
                hoverRadius: function(context) {
                    const dataset = context.dataset;
                    const isPredictionPoint = context.dataIndex === context.dataset.data.length - 1;
                    
                    if (dataset.label.includes('Forecast') && isPredictionPoint) {
                        return 12; // Titik prediksi lebih besar saat hover
                    }
                    return 8; // Titik biasa
                }
            },
            line: {
                tension: 0.2
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    },
    plugins: [simplifiedLegend]
});

// Tambahkan garis vertikal pemisah antara data historis dan prediksi
setTimeout(() => {
    const chartContainer = ctxLine.canvas.parentElement;
    if (chartContainer) {
        // Hitung posisi pemisah (antara tahun terakhir historis dan prediksi)
        const totalYears = allYears.length;
        const lastHistoricalIndex = totalYears - 2; // Index tahun 2025
        const predictionIndex = totalYears - 1; // Index tahun 2026
        
        // Buat elemen garis pemisah
        const divider = document.createElement('div');
        divider.style.cssText = `
            position: absolute;
            top: 0;
            left: ${((lastHistoricalIndex + 0.5) / totalYears * 100)}%;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #58a6ff, transparent);
            z-index: 1;
            pointer-events: none;
        `;
        chartContainer.style.position = 'relative';
        chartContainer.appendChild(divider);
        
        // Tambahkan label prediksi
        const prediksiLabel = document.createElement('div');
        prediksiLabel.style.cssText = `
            position: absolute;
            top: 10px;
            left: ${((predictionIndex - 0.3) / totalYears * 100)}%;
            color: #58a6ff;
            font-size: 12px;
            font-weight: bold;
            background: rgba(13, 17, 23, 0.8);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #30363d;
            z-index: 1;
            pointer-events: none;
        `;
        prediksiLabel.textContent = `Prediksi ${nextYear}`;
        chartContainer.appendChild(prediksiLabel);
    }
}, 500);
        // Bar Chart
        // Bar Chart - MODIFIKASI: Kelompokkan ukuran kecil
const ctxBar = document.getElementById('yearlyChart').getContext('2d');
const allYearsForPercentage = [...years, nextYear];

// Identifikasi ukuran yang akan digabungkan
const smallSizes = ['3XL', '4XL', '5XL', '6XL', '7XL','8XL','9XL', 'XXL', 'XXXL']; // Tambahkan variasi jika perlu
let groupedChartData = {};
let individualChartData = {};
let smallSizesGroup = {};

// Pisahkan data menjadi individual dan kelompok kecil
Object.keys(chartData).forEach(key => {
    const sizeName = key.trim().toUpperCase();
    const isSmallSize = smallSizes.some(size => sizeName.includes(size));
    
    if (isSmallSize) {
        // Gabungkan ke kelompok kecil
        if (!smallSizesGroup['data']) {
            smallSizesGroup['data'] = Array(allYearsForPercentage.length).fill(0);
            smallSizesGroup['labels'] = [];
        }
        
        // Tambahkan data ke kelompok kecil
        const dataset = chartData[key];
        allYearsForPercentage.forEach((year, index) => {
            const dataValue = dataset[index] || (index === allYearsForPercentage.length - 1 ? dataset[dataset.length - 1] : 0);
            smallSizesGroup['data'][index] += dataValue || 0;
        });
        
        // Simpan label asli untuk tooltip
        smallSizesGroup['labels'] = smallSizesGroup['labels'] || [];
        if (!smallSizesGroup['labels'].includes(key)) {
            smallSizesGroup['labels'].push(key);
        }
        
        // Simpan data asli untuk tooltip
        smallSizesGroup[key] = dataset;
    } else {
        // Simpan sebagai individual
        individualChartData[key] = chartData[key];
    }
});

// Gabungkan semua data untuk chart
groupedChartData = { ...individualChartData };
if (smallSizesGroup['data'] && smallSizesGroup['data'].length > 0) {
    groupedChartData['3XL+'] = smallSizesGroup['data'];
}

// Hitung total per tahun
const yearlyTotals = allYearsForPercentage.map((year, index) => {
    return Object.values(groupedChartData).reduce((sum, dataset) => {
        const dataValue = dataset[index] || (index === allYearsForPercentage.length - 1 ? dataset[dataset.length - 1] : 0);
        return sum + (dataValue || 0);
    }, 0);
});

// Hitung persentase
const percentageData = {};
Object.keys(groupedChartData).forEach(key => {
    percentageData[key] = allYearsForPercentage.map((year, index) => {
        const dataset = groupedChartData[key];
        const dataValue = dataset[index] || (index === allYearsForPercentage.length - 1 ? dataset[dataset.length - 1] : 0);
        const total = yearlyTotals[index];
        return total > 0 ? (dataValue / total) * 100 : 0;
    });
});

// Warna dengan maksimal 6 warna
const barColors = [
    '#58a6ff', // Biru muda
    '#3fb950', // Hijau
    '#f85149', // Merah
    '#d29922', // Kuning
    '#db61a2', // Pink
    '#8b949e'  // Abu-abu
];

const barDatasets = Object.keys(percentageData).map((key, idx) => ({
    label: key,
    data: percentageData[key],
    backgroundColor: barColors[idx % barColors.length],
    hoverBackgroundColor: barColors[idx % barColors.length],
    borderColor: '#ffffff',
    borderWidth: 1,
    barThickness: 26,
    borderRadius: 6
}));

// Plugin untuk label dalam bar
// Plugin untuk label dalam bar - PERBAIKAN
const insideLabelsPlugin = {
    id: 'insideLabels',
    afterDatasetsDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        
        if (!chartArea) return;
        
        ctx.save();

        chart.data.datasets.forEach((dataset, datasetIndex) => {
            const meta = chart.getDatasetMeta(datasetIndex);
            
            meta.data.forEach((bar, index) => {
                const value = dataset.data[index];
                if (!value || value < 3) return; // Kurangi threshold untuk menampilkan label
                
                // Untuk horizontal bar (indexAxis: 'y'), bar.x adalah posisi vertikal
                // dan bar.y adalah posisi horizontal
                
                // Dapatkan nilai dari skala
                const xScale = scales.x;
                const yScale = scales.y;
                
                // Posisi awal bar (kiri)
                const barStart = bar.base;
                // Posisi akhir bar (kanan)
                const barEnd = bar.x;
                // Lebar bar (dalam pixel)
                const barWidth = Math.abs(barEnd - barStart);
                
                // Hitung posisi tengah bar HORIZONTAL
                const centerX = barStart + (barWidth / 2);
                const centerY = bar.y;
                
                // Text yang akan ditampilkan
                const text = value.toFixed(0) + '%';
                
                // Styling text
                ctx.font = 'bold 11px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const padding = 4;
                const textWidth = ctx.measureText(text).width;
                
                // Hanya tampilkan label jika cukup ruang
                if (textWidth + padding * 2 < barWidth * 0.9) {
                    // Background untuk label
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    ctx.fillRect(
                        centerX - textWidth / 2 - padding,
                        centerY - 10,
                        textWidth + padding * 2,
                        20
                    );
                    
                    // Text label
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(text, centerX, centerY);
                } else {
                    // Jika tidak cukup ruang, tampilkan di luar bar
                    ctx.fillStyle = '#ffffff';
                    ctx.textAlign = 'left';
                    ctx.fillText(text, barEnd + 5, centerY);
                }
            });
        });
        ctx.restore();
    }
};

// Custom tooltip untuk menampilkan detail ukuran kecil
const customTooltip = {
    id: 'customTooltip',
    afterDraw(chart) {
        // Tidak perlu custom drawing untuk tooltip, gunakan callback di options
    }
};

new Chart(ctxBar, {
    type: 'bar',
    data: {
        labels: allYearsForPercentage,
        datasets: barDatasets
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            title: {
                display: true,
                text: 'Distribusi Permintaan per Tahun (%) - Termasuk Prediksi ' + nextYear,
                font: { size: 16, weight: 'bold' },
                color: '#f0f6fc'
            },
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    boxWidth: 10,
                    font: { size: 12 },
                    color: '#8b949e',
                    padding: 20
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                axis: 'y',
                backgroundColor: '#21262d',
                titleColor: '#f0f6fc',
                bodyColor: '#f0f6fc',
                borderColor: '#30363d',
                borderWidth: 1,
                padding: 12,
                callbacks: {
                    title: function(tooltipItems) {
                        const dataIndex = tooltipItems[0].dataIndex;
                        const year = allYearsForPercentage[dataIndex];
                        const isPrediction = dataIndex === allYearsForPercentage.length - 1;
                        return isPrediction ? `Prediksi ${year}` : `Tahun ${year}`;
                    },
                    label: function(context) {
                        const label = context.dataset.label;
                        const percent = context.parsed.x.toFixed(1);
                        const yearIndex = context.dataIndex;
                        
                        // Jika ini adalah kelompok kecil, tampilkan detail
                        if (label === '3XL+' && smallSizesGroup['labels']) {
                            let totalValue = 0;
                            let detailLines = [];
                            
                            // Hitung total dan detail untuk setiap ukuran dalam kelompok
                            smallSizesGroup['labels'].forEach(sizeLabel => {
                                const dataset = smallSizesGroup[sizeLabel];
                                let originalValue = dataset[yearIndex];
                                if (yearIndex === allYearsForPercentage.length - 1) {
                                    originalValue = dataset[dataset.length - 1];
                                }
                                if (originalValue > 0) {
                                    totalValue += originalValue;
                                    const sizePercent = yearlyTotals[yearIndex] > 0 ? 
                                        (originalValue / yearlyTotals[yearIndex] * 100).toFixed(1) : 0;
                                    detailLines.push(`  â€¢ ${sizeLabel}: ${sizePercent}% (${originalValue} unit)`);
                                }
                            });
                            
                            const isPrediction = yearIndex === allYearsForPercentage.length - 1;
                            const suffix = isPrediction ? ' (Prediksi)' : '';
                            
                            return [
                                `3XL+ (Gabungan): ${percent}% (${totalValue} unit${suffix})`,
                                ...detailLines
                            ];
                        } else {
                            // Untuk ukuran individual
                            const dataset = chartData[label];
                            let originalValue = dataset[yearIndex];
                            if (yearIndex === allYearsForPercentage.length - 1) {
                                originalValue = dataset[dataset.length - 1];
                            }
                            
                            const isPrediction = yearIndex === allYearsForPercentage.length - 1;
                            const suffix = isPrediction ? ' (Prediksi)' : '';
                            return `${label}: ${percent}% (${originalValue.toLocaleString('id-ID')} unit${suffix})`;
                        }
                    },
                    afterBody: function(tooltipItems) {
                        // Tambahkan total di bagian bawah tooltip
                        const yearIndex = tooltipItems[0].dataIndex;
                        const total = yearlyTotals[yearIndex];
                        const isPrediction = yearIndex === allYearsForPercentage.length - 1;
                        const suffix = isPrediction ? ' (Prediksi)' : '';
                        
                        return [
                            '',
                            `Total: ${total.toLocaleString('id-ID')} unit${suffix}`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                stacked: true,
                max: 100,
                ticks: {
                    callback: value => value + '%',
                    color: '#8b949e'
                },
                title: {
                    display: true,
                    text: 'Persentase',
                    color: '#8b949e'
                },
                grid: { 
                    color: '#30363d',
                    drawBorder: false
                }
            },
            y: {
                stacked: true,
                title: {
                    display: true,
                    text: 'Tahun',
                    color: '#8b949e'
                },
                grid: { 
                    display: false,
                    drawBorder: false
                },
                ticks: { 
                    color: '#8b949e',
                    padding: 10,
                    callback: function(value, index) {
                        const year = allYearsForPercentage[index];
                        const isPrediction = index === allYearsForPercentage.length - 1;
                        return isPrediction ? `Prediksi ${year}` : year;
                    }
                }
            }
        }
    },
    plugins: [insideLabelsPlugin, customTooltip]
});
    } catch (err) {
        console.error("Chart error:", err);
    }
});
        </script>
        <script>
            
// =========================================================
// âœ… PDF WITH DJANGO TEMPLATE DATA - NO DOM SCRAPING
// =========================================================

function generatePDFWithData() {
    console.log('Starting PDF with template data...');
    
    const btn = document.getElementById('downloadPdf');
    const originalHTML = btn.innerHTML;
    
    // Loading state
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Memproses...';
    btn.disabled = true;
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            let yPosition = 20;
            const margin = 15;
            const pageWidth = pdf.internal.pageSize.width;
            const pageHeight = pdf.internal.pageSize.height;
            
            // ===== HEADER =====
            pdf.setFontSize(18);
            pdf.setTextColor(0, 0, 128);
            pdf.text('LAPORAN HASIL PERAMALAN JAS ALMAMATER', pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 8;
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Dibuat pada: ${new Date().toLocaleDateString('id-ID')}`, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            
            // ===== SUMMARY =====
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.text('RINGKASAN HASIL', margin, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.text(`â€¢ Total Ukuran: {{ results|length }}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ MAPE Terbaik: {{ best_mape }}%`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ Tahun Prediksi: {{ results.0.tahun_next }}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ Total Perhitungan: {{ total_calculations }} kombinasi`, margin, yPosition);
            yPosition += 15;
            
            // ===== TABLE 1: MAPE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 100, 0);
            pdf.text('HASIL PREDIKSI - MAPE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(0, 100, 0);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
             pdf.text('Tahun', margin + 100, yPosition + 4);
            // pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data - Using Django template data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha_mape }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.tahun_next }}', margin + 100, yPosition);
            // pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 10;
            
            // ===== TABLE 2: MAE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 150);
            pdf.text('HASIL PREDIKSI - MAE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(0, 0, 150);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
            pdf.text('Tahun', margin + 100, yPosition + 4);
            // pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in mae_best_results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.tahun_next }}', margin + 100, yPosition);
            // pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 10;
            
            // ===== TABLE 3: MSE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(150, 100, 0);
            pdf.text('HASIL PREDIKSI - MSE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(150, 100, 0);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
            pdf.text('Tahun', margin + 100, yPosition + 4);
            // pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in mse_best_results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.tahun_next }}', margin + 100, yPosition);
            
            // pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 15;
            
            // ===== ALL ALPHA COMPARISON =====
            {% for ukuran, calculations in all_calculations.items %}
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`PERBANDINGAN SEMUA ALPHA - {{ ukuran }}`, margin, yPosition);
            yPosition += 6;
            
            // Sub-header
            pdf.setFontSize(7);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Alpha', margin + 2, yPosition);
            pdf.text('MAPE%', margin + 15, yPosition);
            pdf.text('MAE', margin + 30, yPosition);
            pdf.text('MSE', margin + 45, yPosition);
            pdf.text('Forecast', margin + 60, yPosition);
            
            yPosition += 4;
            
            {% for calc in calculations %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(7);
            pdf.setTextColor(0, 0, 0);
            
            pdf.text('{{ calc.alpha }}', margin + 2, yPosition);
            pdf.text('{{ calc.mape }}%', margin + 15, yPosition);
            pdf.text('{{ calc.mae }}', margin + 30, yPosition);
            pdf.text('{{ calc.mse }}', margin + 45, yPosition);
            pdf.text('{{ calc.forecast_next }}', margin + 60, yPosition);
            
            yPosition += 4;
            {% endfor %}
            
            yPosition += 8;
            {% endfor %}
            
            // ===== FOOTER =====
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }
            
            // Save PDF
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            pdf.save(`Laporan-Peramalan-${timestamp}.pdf`);
            
            console.log('PDF dengan data template berhasil dibuat!');
            
        } catch (error) {
            console.error('Error creating PDF:', error);
            alert('Gagal membuat PDF: ' + error.message);
        } finally {
            // Restore button
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }, 100);
}

// =========================================================
// ðŸŽ¯ SIMPLE EVENT HANDLER
// =========================================================

function initializePDF() {
    const btn = document.getElementById('downloadPdf');
    if (btn) {
        // Remove any existing listeners
        btn.replaceWith(btn.cloneNode(true));
        
        // Get new reference
        const newBtn = document.getElementById('downloadPdf');
        
        // Add click handler
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            generatePDFWithData();
        });
        
        console.log('PDF button initialized successfully');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializePDF);

// Backup initialization
setTimeout(initializePDF, 500);
        </script>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </body>
    </html>