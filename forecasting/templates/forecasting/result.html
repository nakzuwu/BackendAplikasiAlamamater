    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Hasil Peramalan Jas Almamater</title>

        <!-- Bootstrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

        <style>
            :root {
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-card: #21262d;
                --text-primary: #f0f6fc;
                --text-secondary: #8b949e;
                --accent-primary: #58a6ff;
                --accent-secondary: #1f6feb;
                --border-color: #30363d;
                --success: #3fb950;
                --warning: #d29922;
                --danger: #f85149;
            }

            body {
                background-color: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
                transition: all 0.3s ease;
            }

            .container {
                max-width: 1400px;
                margin-top: 40px;
                margin-bottom: 60px;
            }

            .card {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            }

            .table {
                color: var(--text-primary);
                border-color: var(--border-color);
            }

            .table th {
                background-color: var(--accent-secondary);
                color: white;
                text-align: center;
                vertical-align: middle;
                font-weight: 600;
                border: none;
                padding: 12px 8px;
            }

            .table td {
                text-align: center;
                vertical-align: middle;
                padding: 12px 8px;
                border-color: var(--border-color);
            }

            .table-striped tbody tr:nth-of-type(odd) {
                background-color: rgba(255, 255, 255, 0.03);
            }

            .table-striped tbody tr:nth-of-type(even) {
                background-color: rgba(255, 255, 255, 0.06);
            }

            .table-striped tbody tr:hover {
                background-color: rgba(88, 166, 255, 0.1);
            }

            .btn-primary {
                background-color: var(--accent-primary);
                border-color: var(--accent-primary);
                color: white;
                font-weight: 500;
                padding: 10px 20px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                background-color: var(--accent-secondary);
                border-color: var(--accent-secondary);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
            }

            .btn-secondary {
                background-color: var(--bg-secondary);
                border-color: var(--border-color);
                color: var(--text-primary);
                padding: 10px 20px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .btn-secondary:hover {
                background-color: var(--border-color);
                border-color: var(--text-secondary);
                transform: translateY(-2px);
            }

            .alert-danger {
                background-color: rgba(248, 81, 73, 0.15);
                border-color: var(--danger);
                color: var(--danger);
                border-radius: 8px;
            }

            h1, h2, h3, h4, h5, h6 {
                color: var(--text-primary);
                font-weight: 600;
            }

            .text-primary {
                color: var(--accent-primary) !important;
            }

            .text-secondary {
                color: var(--text-secondary) !important;
            }

            .text-muted {
                color: var(--text-secondary) !important;
            }

            #multiChart, #yearlyChart {
                width: 100% !important;
                min-height: 350px;
                max-height: 500px;
            }

            .header-icon {
                font-size: 1.8rem;
                margin-right: 10px;
                vertical-align: middle;
            }

            .metric-highlight {
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                color: white;
                padding: 4px 10px;
                border-radius: 6px;
                font-weight: 600;
            }

            .metric-container {
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 25px;
            }

            .metric-card {
                flex: 1;
                min-width: 200px;
                background-color: var(--bg-secondary);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
                border-left: 4px solid var(--accent-primary);
            }

            .metric-value {
                font-size: 1.8rem;
                font-weight: 700;
                margin: 10px 0;
                color: var(--accent-primary);
            }

            .metric-label {
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .footer {
                margin-top: 40px;
                padding: 20px 0;
                text-align: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
                border-top: 1px solid var(--border-color);
            }

            .theme-toggle {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 1000;
                transition: all 0.3s ease;
            }

            .theme-toggle:hover {
                transform: rotate(15deg);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .calculation-card {
                background: var(--bg-secondary);
                border-left: 4px solid var(--accent-primary);
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
            }

            .formula {
                font-family: "Courier New", monospace;
                background: var(--bg-primary);
                padding: 12px;
                border-radius: 6px;
                margin: 8px 0;
                border: 1px solid var(--border-color);
                color: var(--accent-primary);
                font-weight: 500;
            }

            .calculation-step {
                background: var(--bg-secondary);
                padding: 10px;
                border-radius: 6px;
                margin: 5px 0;
                border-left: 3px solid var(--success);
            }

            .btn-info {
                background-color: #17a2b8;
                border-color: #17a2b8;
                color: white;
            }

            .btn-info:hover {
                background-color: #138496;
                border-color: #117a8b;
            }

            .method-badge {
                font-size: 0.8rem;
                padding: 4px 8px;
            }

            .best-metric {
                background: linear-gradient(135deg, var(--success), #2ea043);
                color: white;
                font-weight: bold;
                padding: 2px 8px;
                border-radius: 4px;
            }

            @media (max-width: 768px) {
                .container {
                    margin-top: 70px;
                }

                .table-responsive {
                    font-size: 0.85rem;
                }

                .metric-card {
                    min-width: 100%;
                }
            }
            /* Tambahkan di bagian style */
            .btn-danger {
                background: linear-gradient(135deg, #dc3545, #c82333);
                border: none;
                padding: 12px 30px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-danger:hover {
                background: linear-gradient(135deg, #c82333, #bd2130);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            }

            /* Loading state */
            .btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
        </style>
    </head>

    <body>
        <div class="container">
            {% if error %}
            <div class="alert alert-danger text-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
            </div>
            <div class="text-center">
                <a href="/" class="btn btn-secondary mt-3">
                    <i class="bi bi-arrow-left me-2"></i>Kembali
                </a>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
    <i class="bi bi-sliders me-2"></i>
    <strong>Presisi Alpha:</strong> 
    {% if alpha_step == 0.01 %}
        Menggunakan Alpha Step 0.01 (99 kombinasi alpha)
    {% else %}
        Menggunakan Alpha Step 0.1 (9 kombinasi alpha)
    {% endif %}
    | 
    <strong>Total Perhitungan:</strong> {{ total_calculations }} kombinasi
</div>

            <div class="text-center mb-5">
                <h1 class="fw-bold text-primary mb-3">
                    <i class="bi bi-graph-up header-icon"></i>Hasil Peramalan Jas Almamater
                </h1>
                <p class="text-muted fs-5">
                    Analisis Prediksi Berdasarkan Multiple Metode Evaluasi
                </p>
            </div>

<!-- Metrics Summary -->
<div class="metric-container">
    <div class="metric-card">
        <div class="metric-label">Total Ukuran</div>
        <div class="metric-value">{{ results|length }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">MAPE Terbaik</div>
        <div class="metric-value">{{ best_mape|floatformat:1 }}%</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">MAE Terbaik</div>
        <div class="metric-value">
            {% with best_mae=results|dictsort:"mae"|first %}
                {{ best_mae.mae|floatformat:0 }}
            {% endwith %}
        </div>
    </div>
    <div class="metric-card">
    <div class="metric-label">Alpha Step</div>
    <div class="metric-value">
        {% if alpha_step == 0.01 %}
            0.01 (99)
        {% else %}
            0.1 (9)
        {% endif %}
    </div>
</div>
    <div class="metric-card">
        <div class="metric-label">MSE Terbaik</div>
        <div class="metric-value">
            {% with best_mse=results|dictsort:"mse"|first %}
                {{ best_mse.mse|floatformat:0 }}
            {% endwith %}
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Tahun Prediksi</div>
        <div class="metric-value">{{ results.0.tahun_next }}</div>
    </div>
</div>

<!-- 1. Table Hasil Prediksi menggunakan MAPE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MAPE Terbaik
    </h4>
    <div class="alert alert-success mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MAPE (Mean Absolute Percentage Error):</strong> Metode terbaik berdasarkan error persentase terkecil. 
        MAPE < 10% = Akurasi Tinggi, 10-20% = Baik, >20% = Perlu Perbaikan
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th>
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <th>Trend</th>
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha_mape|floatformat:2 }}
        {% else %}
            {{ r.alpha_mape|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>
                        <span class="best-metric">{{ r.mape|floatformat:1 }}%</span>
                    </td>
                    <td>{{ r.mae|floatformat:0 }}</td>
                    <td>{{ r.mse|floatformat:0 }}</td>
                    <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td>
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-warning bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td>
                    <td>
<button class="btn btn-sm btn-outline-info" 
        onclick='showAllCalculations(
            "{{ r.ukuran }}", 
            {{ r.alpha_mape }},
            {{ r.actual_last }}, 
            {{ r.forecast_last }}, 
            {{ r.forecast_next }}, 
            {{ r.mape }},
            {{ r.mae }},
            {{ r.mse }},
            "MAPE",
            {{ r.yearly_calculations_json|safe }},
            {{ r.yearly_metrics_json|safe }},
            {{ r.all_alpha_data_json|safe }},
            {{ alpha_step }}
        )'>
    <i class="bi bi-calculator me-1"></i>Lihat Detail
</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 2. Table Hasil Prediksi menggunakan MAE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MAE Terbaik
    </h4>
    <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MAE (Mean Absolute Error):</strong> Metode terbaik berdasarkan error absolut terkecil. 
        Semakin kecil MAE semakin akurat prediksi dalam satuan asli data.
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th>
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <th>Trend</th>
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in mae_best_results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha|floatformat:2 }}
        {% else %}
            {{ r.alpha|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>{{ r.mape|floatformat:1 }}%</td>
                    <td>
                        <span class="best-metric">{{ r.mae|floatformat:0 }}</span>
                    </td>
                    <td>{{ r.mse|floatformat:0 }}</td>
                    <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td>
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-info bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td>
                    <td>
<button class="btn btn-sm btn-outline-info" 
        onclick='showAllCalculations(
            "{{ r.ukuran }}", 
            {{ r.alpha_mae }}, 
            {{ r.actual_last }}, 
            {{ r.forecast_last|default:0 }}, 
            {{ r.forecast_next }}, 
            {{ r.mape }},
            {{ r.mae }},
            {{ r.mse }},
            "MAE",
            {{ r.yearly_calculations_json|default:"[]"|safe }},
            {{ r.yearly_metrics_json|default:"[]"|safe }},
            {{ r.all_alpha_data_json|default:"[]"|safe }},
            {{ alpha_step }}
        )'>
    <i class="bi bi-calculator me-1"></i>Lihat Detail
</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 3. Table Hasil Prediksi menggunakan MSE Terbaik -->
<div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-table header-icon"></i>Hasil Prediksi Berdasarkan MSE Terbaik
    </h4>
    <div class="alert alert-warning mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>MSE (Mean Squared Error):</strong> Metode terbaik berdasarkan error kuadrat terkecil. 
        Lebih sensitif terhadap outlier, memberikan penalti lebih besar untuk error yang besar.
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Ukuran</th>
                    <th>Alpha (Î±)</th>
                    <th>MAPE (%)</th>
                    <th>MAE</th>
                    <th>MSE</th>
                    <th>Tahun Terakhir</th>
                    <th>Aktual (A<sub>t</sub>)</th>
                    <th>Tahun Berikutnya</th>
                    <th>Forecast (F<sub>t+1</sub>)</th>
                    <th>Trend</th>
                    <th>Detail Perhitungan</th>
                </tr>
            </thead>
            <tbody>
                {% for r in mse_best_results %}
                <tr>
                    <td><strong>{{ r.ukuran }}</strong></td>
                    <td>
    <span class="badge bg-primary method-badge">
        {% if alpha_step == 0.01 %}
            {{ r.alpha|floatformat:2 }}
        {% else %}
            {{ r.alpha|floatformat:1 }}
        {% endif %}
    </span>
</td>
                    <td>{{ r.mape|floatformat:2 }}%</td>
                    <td>{{ r.mae|floatformat:0 }}</td>
                    <td>
                        <span class="best-metric">{{ r.mse|floatformat:0 }}</span>
                    </td>
                    <td>{{ r.tahun_last }}</td>
                    <td>{{ r.actual_last|floatformat:0 }}</td>
                    <td>{{ r.tahun_next }}</td>
                    <td class="bg-warning bg-opacity-25 fw-bold">
                        {{ r.forecast_next|floatformat:0 }}
                    </td>
                    <td>
                        {% if r.forecast_trend == 'Naik' %}
                            <span class="badge bg-success"><i class="bi bi-arrow-up"></i></span>
                        {% elif r.forecast_trend == 'Turun' %}
                            <span class="badge bg-danger"><i class="bi bi-arrow-down"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                        {% endif %}
                    </td>
                    <td>
<button class="btn btn-sm btn-outline-info" 
        onclick='showAllCalculations(
            "{{ r.ukuran }}", 
            {{ r.alpha_mse }}, 
            {{ r.actual_last }}, 
            {{ r.forecast_last|default:0 }}, 
            {{ r.forecast_next }}, 
            {{ r.mape }},
            {{ r.mae }},
            {{ r.mse }},
            "MSE",
            {{ r.yearly_calculations_json|default:"[]"|safe }},
            {{ r.yearly_metrics_json|default:"[]"|safe }},
            {{ r.all_alpha_data_json|default:"[]"|safe }},
            {{ alpha_step }}
        )'>
    <i class="bi bi-calculator me-1"></i>Lihat Detail
</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card p-4 mb-5">
 <div class="card p-4 mb-5">
    <h4 class="text-secondary mb-4 text-center">
        <i class="bi bi-bar-chart header-icon"></i>Perbandingan Semua Alpha 
        <span class="badge bg-info ms-2">
            {% if alpha_step == 0.01 %}Step 0.01{% else %}Step 0.1{% endif %}
        </span>
    </h4>

    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Total Perhitungan:</strong> {{ total_calculations }} kombinasi 
        ({% if alpha_step == 0.01 %}99{% else %}9{% endif %} alpha Ã— {{ results|length }} ukuran)
    </div>

    {% for ukuran, calculations in all_calculations.items %}
    <div class="mb-4">
        <h5 class="text-primary mb-3">
            <i class="bi bi-graph-up"></i> Ukuran: {{ ukuran }}
            <span class="badge bg-secondary">
                {% if alpha_step == 0.01 %}99{% else %}9{% endif %} Kombinasi Alpha
            </span>
        </h5>

        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr class="table-dark">
                        <th>Alpha (Î±)</th>
                        <th>MAPE (%)</th>
                        <th>MAE</th>
                        <th>MSE</th>
                        <th>Keterangan</th>
                        <th>Forecast (F<sub>t+1</sub>)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for calc in calculations %}
                    <tr>
                        <td>
                            <strong>
                                {% if alpha_step == 0.01 %}
                                    {{ calc.alpha|floatformat:2 }}
                                {% else %}
                                    {{ calc.alpha|floatformat:1 }}
                                {% endif %}
                            </strong>
                        </td>
                        <td>
                            {{ calc.mape|floatformat:1 }}%
                            {% if calc.is_best_mape %}
                                <span class="badge bg-success">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ calc.mae|floatformat:0 }}
                            {% if calc.is_best_mae %}
                                <span class="badge bg-info">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ calc.mse|floatformat:0 }}
                            {% if calc.is_best_mse %}
                                <span class="badge bg-warning">Terbaik</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if calc.is_best_mape %}
                                <span class="badge bg-success">MAPE Terbaik</span>
                            {% endif %}
                            {% if calc.is_best_mae %}
                                <span class="badge bg-info">MAE Terbaik</span>
                            {% endif %}
                            {% if calc.is_best_mse %}
                                <span class="badge bg-warning">MSE Terbaik</span>
                            {% endif %}
                        </td>
                        <td class="fw-bold">
                            {{ calc.forecast_next|floatformat:0 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Tambahkan informasi alpha terbaik untuk ukuran ini -->
        {% with result=results|first %}
            {% if result.ukuran == ukuran %}
                <div class="alert alert-light mt-2">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Alpha terbaik untuk {{ ukuran }}:</strong><br>
                        â€¢ MAPE Terbaik: Alpha {{ result.alpha_mape|floatformat:2 }} = {{ result.mape|floatformat:1 }}%<br>
                        â€¢ MAE Terbaik: Alpha {{ result.alpha_mae|floatformat:2 }} = {{ result.mae|floatformat:0 }}<br>
                        â€¢ MSE Terbaik: Alpha {{ result.alpha_mse|floatformat:2 }} = {{ result.mse|floatformat:0 }}
                    </small>
                </div>
            {% endif %}
        {% endwith %}
    </div>
    {% endfor %}
</div>
            <!-- 5. Semua Rumus Perhitungan -->
            <div class="card p-4 mb-5">
                <h4 class="text-secondary mb-4 text-center">
                    <i class="bi bi-calculator header-icon"></i>Rumus Perhitungan Lengkap
                </h4>

                <div class="row">
                    <!-- Metode Exponential Smoothing -->
                    <div class="col-md-6 mb-4">
                        <div class="calculation-card">
                            <h5 class="text-primary">Metode: Single Exponential Smoothing</h5>
                            <p class="text-muted">
                                Metode pembobotan eksponensial untuk data time series
                            </p>

                            <div class="calculation-card">
                                <strong>Rumus Exponential Smoothing:</strong>
                                <div class="formula">
                                    F<sub>t</sub> = Î± Ã— A<sub>t-1</sub> + (1-Î±) Ã— F<sub>t-1</sub>
                                </div>
                                <small class="text-muted">Dimana: F<sub>t</sub> = Forecast periode t, A<sub>t-1</sub> = Actual periode t-1, Î± = Alpha (konstanta smoothing 0.1-0.9)</small>
                            </div>

                            <div class="calculation-card">
                                <strong>Rumus Forecast Tahun Berikutnya:</strong>
                                <div class="formula">
                                    F<sub>t+1</sub> = Î± Ã— A<sub>t</sub> + (1-Î±) Ã— F<sub>t</sub>
                                </div>
                                <small class="text-muted">Forecast untuk tahun berikutnya menggunakan data aktual terakhir dan forecast terakhir</small>
                            </div>
                        </div>
                    </div>

                    <!-- Metode Evaluasi -->
                    <div class="col-md-6 mb-4">
                        <div class="calculation-card">
                            <h5 class="text-primary">Metode Evaluasi Akurasi</h5>
                            
                            <div class="calculation-card">
                                <strong>MAPE (Mean Absolute Percentage Error):</strong>
                                <div class="formula">
                                    MAPE = (1/n) Ã— Î£ |(A<sub>t</sub> - F<sub>t</sub>) / A<sub>t</sub>| Ã— 100%
                                </div>
                                <small class="text-muted">Mengukur error dalam persentase relatif. < 10% = Excellent</small>
                            </div>

                            <div class="calculation-card">
                                <strong>MAE (Mean Absolute Error):</strong>
                                <div class="formula">
                                    MAE = (1/n) Ã— Î£ |A<sub>t</sub> - F<sub>t</sub>|
                                </div>
                                <small class="text-muted">Mengukur error absolut dalam satuan data asli</small>
                            </div>

                            <div class="calculation-card">
                                <strong>MSE (Mean Squared Error):</strong>
                                <div class="formula">
                                    MSE = (1/n) Ã— Î£ (A<sub>t</sub> - F<sub>t</sub>)Â²
                                </div>
                                <small class="text-muted">Mengukur error kuadrat, sensitif terhadap outlier</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Grafik -->
            <div class="card p-4 mb-5">
                <h4 class="text-secondary text-center mb-4">
                    <i class="bi bi-graph-up-arrow header-icon"></i>Grafik Perbandingan Hasil Forecasting
                </h4>
                <canvas id="multiChart"></canvas>
            </div>
            <div class="card p-4 mb-5">
                <h4 class="text-secondary text-center mb-4">
                    <i class="bi bi-bar-chart-fill header-icon"></i>Grafik Perbandingan per Tahun (%)
                </h4>
                <div style="height: 400px; position: relative;"> <!-- Container dengan tinggi tetap -->
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
            <!-- Tambahkan tombol ini di bagian sebelum tombol "Kembali ke Halaman Awal" -->
            <!-- Ganti bagian tombol di akhir halaman dengan ini -->
            <div class="text-center">
                <div class="mb-4">
                    <button id="downloadPdf" class="btn btn-danger me-3">
                        <i class="bi bi-file-pdf me-2"></i>Download PDF Report
                    </button>
                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Kembali ke Halaman Awal
                    </a>
                </div>
            </div>

            {% endif %}

<!-- Modal untuk Detail Perhitungan -->
<div class="modal fade" id="calculationModal" tabindex="-1" 
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #ffffff; color: #212529;">
            <div class="modal-header" style="background-color: #0d6efd; color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-calculator me-2"></i>Detail Perhitungan Forecasting
                </h5>
                <button type="button" class="btn-close btn-close-white" 
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="calculationDetails" 
                 style="background-color: #ffffff; color: #212529; max-height: 70vh; overflow-y: auto;">
                <!-- Detail perhitungan akan dimuat di sini -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Memuat data perhitungan...</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Tutup
                </button>
            </div>
        </div>
    </div>
</div>

            <div class="footer">
                <p>
                    &copy; 2023 Sistem Peramalan Jas Almamater | Analisis Multiple Metode
                </p>
            </div>
        </div>

        <!-- Chart.js script -->
        <script>
// GLOBAL VARIABLES - MUST BE DECLARED FIRST!
// ============================================================================
let currentModal = null;

// ============================================================================
// HELPER FUNCTIONS - GLOBAL SCOPE (accessible from onclick)
// ============================================================================
function formatNumber(num, decimals = 0) {
    if (num === undefined || num === null || isNaN(num)) return '0';
    const multiplier = Math.pow(10, decimals);
    const rounded = Math.round(num * multiplier) / multiplier;
    
    if (decimals === 0) {
        return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    const parts = rounded.toString().split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(',');
}

function roundNumber(num, decimals = 2) {
    if (num === undefined || num === null) return 0;
    return parseFloat(num.toFixed(decimals));
}

function formatAlphaDisplay(alpha, alphaStep = 0.1) {
    if (alpha === undefined || alpha === null) return '0.00';
    const num = parseFloat(alpha);
    
    if (alphaStep === 0.01) {
        const rounded = Math.round(num * 100) / 100;
        return rounded.toFixed(2);
    } else {
        const rounded = Math.round(num * 10) / 10;
        return rounded.toFixed(1);
    }
}

// ============================================================================
// MAIN MODAL FUNCTION - GLOBAL SCOPE (accessible from onclick)
// ============================================================================
function showAllCalculations(ukuran, alpha, actualLast, forecastLast, forecastNext, 
                            mape, mae, mse, metricType, 
                            yearlyCalculationsJson, yearlyMetricsJson, allAlphasDataJson, alphaStep = 0.1) {
    
    // STEP 1: Close existing modal and cleanup
    if (currentModal) {
        try {
            currentModal.hide();
            currentModal.dispose();
            currentModal = null;
        } catch (e) {
            console.log('Modal cleanup:', e);
        }
        
        // Remove backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    // STEP 2: Parse JSON data
    let yearlyCalculations = [];
    let yearlyMetrics = [];
    let allAlphasData = [];
    
    try {
        yearlyCalculations = typeof yearlyCalculationsJson === 'string' 
            ? JSON.parse(yearlyCalculationsJson) 
            : (yearlyCalculationsJson || []);
        
        yearlyMetrics = typeof yearlyMetricsJson === 'string' 
            ? JSON.parse(yearlyMetricsJson) 
            : (yearlyMetricsJson || []);
        
        allAlphasData = typeof allAlphasDataJson === 'string' 
            ? JSON.parse(allAlphasDataJson) 
            : (allAlphasDataJson || []);
    } catch (error) {
        console.error('JSON parse error:', error);
        alert('Error loading calculation details.');
        return;
    }
    
    // STEP 3: Validate parameters
    alpha = roundNumber(alpha || 0, 2);
    actualLast = roundNumber(actualLast || 0);
    forecastLast = roundNumber(forecastLast || 0);
    forecastNext = roundNumber(forecastNext || 0);
    mape = roundNumber(mape || 0);
    mae = roundNumber(mae || 0);
    mse = roundNumber(mse || 0);
    metricType = metricType || 'MAPE';
    alphaStep = alphaStep || 0.1;
    
    const alphaDisplay = formatAlphaDisplay(alpha, alphaStep);
    
    // STEP 4: Build HTML content
    const cardStyle = "background: #f8f9fa; border-left: 4px solid #58a6ff; padding: 15px; margin: 10px 0; border-radius: 8px; color: #212529;";
    const stepStyle = "background: #e9ecef; padding: 10px; border-radius: 6px; margin: 5px 0; border-left: 3px solid #3fb950; color: #212529;";
    const tableHeaderStyle = "background-color: #198754; color: white;";
    const textInfoStyle = "color: #0dcaf0 !important;";
    const textWarningStyle = "color: #ffc107 !important;";
    const textDangerStyle = "color: #dc3545 !important;";
    const textSuccessStyle = "color: #198754 !important;";
    
    let html = `
        <div style="${cardStyle}">
            <h6 style="color: #0d6efd;">ðŸ“Š Detail Perhitungan Lengkap - ${metricType} Terbaik</h6>
            <p style="color: #6c757d;">
                Ukuran: <strong style="color: #212529;">${ukuran}</strong> | 
                Alpha Terbaik: <strong style="color: #212529;">${alphaDisplay}</strong> | 
                Tahun Berikutnya: <strong style="color: #212529;">${formatNumber(forecastNext)}</strong>
            </p>
        </div>
    `;

    // Alpha comparison table
    if (allAlphasData && allAlphasData.length > 0) {
        const totalAlphas = allAlphasData.length;
        const alphaCountInfo = totalAlphas >= 99 ? "99 kombinasi alpha" : `${totalAlphas} kombinasi alpha`;
        
        html += `
            <div style="${cardStyle}">
                <h6 style="color: #198754;">ðŸ“ˆ Perbandingan Alpha</h6>
                <div class="alert alert-info" style="background-color: #cff4fc; border-color: #b6effb; color: #055160;">
                    <i class="bi bi-info-circle me-2"></i>
                    Total <strong>${alphaCountInfo}</strong> diuji untuk mendapatkan nilai optimal
                </div>
                <div class="table-responsive mt-2" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead style="${tableHeaderStyle}" class="sticky-top">
                            <tr>
                                <th>No</th>
                                <th>Alpha (Î±)</th>
                                <th>MAPE (%)</th>
                                <th>MAE</th>
                                <th>MSE</th>
                                <th>Forecast</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        const sortedAlphas = [...allAlphasData].sort((a, b) => b.alpha - a.alpha);
        
        sortedAlphas.forEach((calc, index) => {
            const isBest = Math.abs(calc.alpha - alpha) < 0.001;
            const alphaDisplayCalc = formatAlphaDisplay(calc.alpha, alphaStep);
            const mapeValue = roundNumber(calc.mape || 0);
            const mapeClass = mapeValue < 10 ? 'text-success' : mapeValue < 20 ? 'text-warning' : 'text-danger';
            
            html += `
                <tr ${isBest ? 'style="background-color: #fff3cd;"' : ''}>
                    <td>${index + 1}</td>
                    <td><strong>${alphaDisplayCalc}</strong></td>
                    <td class="${mapeClass}">${formatNumber(mapeValue)}%</td>
                    <td>${formatNumber(calc.mae || 0)}</td>
                    <td>${formatNumber(calc.mse || 0)}</td>
                    <td>${formatNumber(calc.forecast_next || 0)}</td>
                    <td>${isBest ? '<span class="badge bg-success">TERBAIK</span>' : ''}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Yearly calculations
    if (yearlyCalculations && yearlyCalculations.length > 0) {
        html += `
            <div style="${cardStyle}">
                <h6 style="color: #ffc107;">ðŸ“‹ Detail Perhitungan Forecast dengan Alpha ${alphaDisplay}</h6>
                <div class="alert alert-warning" style="background-color: #fff3cd; border-color: #ffecb5; color: #664d03;">
                    <i class="bi bi-calculator me-2"></i>
                    <strong>Rumus:</strong> F<sub>t</sub> = Î± Ã— A<sub>t-1</sub> + (1-Î±) Ã— F<sub>t-1</sub>
                </div>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-bordered" style="color: #212529;">
                        <thead style="background-color: #ffc107; color: #212529;">
                            <tr>
                                <th>Tahun</th>
                                <th>Aktual</th>
                                <th>Forecast</th>
                                <th>Perhitungan</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        yearlyCalculations.forEach(calc => {
            html += `
                <tr>
                    <td><strong>${calc.tahun || '-'}</strong></td>
                    <td>${formatNumber(calc.actual)}</td>
                    <td>${formatNumber(calc.forecast)}</td>
                    <td><small>${calc.calculation || '-'}</small></td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Yearly metrics
    if (yearlyMetrics && yearlyMetrics.length > 0) {
        html += `
            <div style="${cardStyle}">
                <h6 style="color: #0dcaf0;">ðŸ“Š Detail Perhitungan ${metricType}</h6>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-bordered" style="color: #212529;">
                        <thead style="background-color: #0dcaf0; color: #212529;">
                            <tr>
                                <th>Tahun</th>
                                <th>Aktual</th>
                                <th>Forecast</th>
                                <th>Error</th>
                                <th>Abs Error</th>
                                <th>Sq Error</th>
                                <th>% Error</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        yearlyMetrics.forEach(metric => {
            const error = roundNumber((metric.actual || 0) - (metric.forecast || 0));
            
            html += `
                <tr>
                    <td><strong>${metric.tahun || '-'}</strong></td>
                    <td>${formatNumber(metric.actual)}</td>
                    <td>${formatNumber(metric.forecast)}</td>
                    <td>${formatNumber(error)}</td>
                    <td style="${textInfoStyle}">${formatNumber(metric.absolute_error)}</td>
                    <td style="${textWarningStyle}">${formatNumber(metric.squared_error)}</td>
                    <td style="${textDangerStyle}">${formatNumber(metric.percentage_error)}%</td>
                </tr>
            `;
        });

        html += `
                            <tr style="background-color: #d1e7dd; font-weight: bold;">
                                <td colspan="4" style="text-align: end;">RATA-RATA â†’</td>
                                <td style="${textInfoStyle}">${formatNumber(mae)}<br><small>MAE</small></td>
                                <td style="${textWarningStyle}">${formatNumber(mse)}<br><small>MSE</small></td>
                                <td style="${textDangerStyle}">${formatNumber(mape)}%<br><small>MAPE</small></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Conclusion
    let badgeStyle = 'background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;';
    let metricName = 'MAPE (Mean Absolute Percentage Error)';
    
    if (metricType === 'MAE') {
        badgeStyle = 'background-color: #cff4fc; border-color: #b6effb; color: #055160;';
        metricName = 'MAE (Mean Absolute Error)';
    } else if (metricType === 'MSE') {
        badgeStyle = 'background-color: #fff3cd; border-color: #ffecb5; color: #664d03;';
        metricName = 'MSE (Mean Squared Error)';
    }
    
    html += `
        <div class="alert mt-3" style="${badgeStyle}">
            <i class="bi bi-trophy-fill me-2"></i>
            <strong>Kesimpulan:</strong><br>
            Alpha <strong>${alphaDisplay}</strong> dipilih karena memberikan nilai 
            <strong>${metricType} terkecil</strong> (${metricName}) untuk ukuran ${ukuran}.
        </div>

        <div class="alert alert-success mt-3" style="background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Hasil Prediksi:</strong><br>
            Forecast kebutuhan untuk ukuran ${ukuran} adalah 
            <strong>${formatNumber(forecastNext)} unit</strong>.
        </div>
    `;

    // STEP 5: Update DOM
    const detailsElement = document.getElementById('calculationDetails');
    if (!detailsElement) {
        console.error('calculationDetails not found!');
        return;
    }
    detailsElement.innerHTML = html;
    
    // STEP 6: Get modal element
    const modalElement = document.getElementById('calculationModal');
    if (!modalElement) {
        console.error('calculationModal not found!');
        return;
    }
    
    // STEP 7: Style modal
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
        modalContent.style.backgroundColor = '#ffffff';
        modalContent.style.color = '#212529';
    }
    
    // STEP 8: Show modal with delay to prevent blinking
    setTimeout(() => {
        try {
            currentModal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: true,
                focus: true
            });
            
            currentModal.show();
            
            // Cleanup on hide
            modalElement.addEventListener('hidden.bs.modal', function () {
                if (currentModal) {
                    currentModal.dispose();
                    currentModal = null;
                }
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, { once: true });
            
        } catch (error) {
            console.error('Error showing modal:', error);
        }
    }, 150); // Delay prevents blinking
}

// ============================================================================
// CHARTS AND OTHER CODE - DOM READY
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Cleanup orphaned modals
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    
    // Charts
    try {
        const chartData = {{ chart_data|safe }};
        const years = {{ years|safe }};
        const nextYear = {{ results.0.tahun_next|safe }};
        
        const allYears = [...years, nextYear];
        
        const colors = [
            '#58a6ff', '#3fb950', '#f85149', '#d29922', '#db61a2', '#8b949e'
        ];

        // Line Chart
        const ctxLine = document.getElementById('multiChart').getContext('2d');
        const datasets = [];

        let i = 0;
        for (const [key, values] of Object.entries(chartData)) {
            if (Array.isArray(values) && values.length > 0) {
                datasets.push({
                    label: key,
                    data: values,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 4,
                    pointHoverRadius: 8,
                    pointBackgroundColor: colors[i % colors.length],
                });
            }
            i++;
        }
        
        new Chart(ctxLine, {
            type: 'line',
            data: { 
                labels: allYears,
                datasets: datasets 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trend Forecasting Semua Ukuran (Termasuk Prediksi ' + nextYear + ')',
                        color: '#f0f6fc',
                        font: { size: 16 }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#8b949e',
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#21262d',
                        titleColor: '#f0f6fc',
                        bodyColor: '#f0f6fc',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        callbacks: {
                            title: function(tooltipItems) {
                                const year = allYears[tooltipItems[0].dataIndex];
                                const isPrediction = tooltipItems[0].dataIndex === allYears.length - 1;
                                return isPrediction ? `Prediksi ${year}` : `Tahun ${year}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tahun',
                            color: '#8b949e'
                        },
                        grid: { 
                            color: '#30363d',
                            drawOnChartArea: true
                        },
                        ticks: { 
                            color: '#8b949e',
                            callback: function(value, index) {
                                return allYears[index];
                            }
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Jumlah Permintaan',
                            color: '#8b949e'
                        },
                        grid: { color: '#30363d' },
                        ticks: { 
                            color: '#8b949e',
                            callback: function(value) {
                                return value.toLocaleString('id-ID');
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: function(context) {
                            return context.dataIndex === context.dataset.data.length - 1 ? 6 : 4;
                        }
                    }
                }
            }
        });

        // Bar Chart
        const ctxBar = document.getElementById('yearlyChart').getContext('2d');
        const allYearsForPercentage = [...years, nextYear];

        const yearlyTotals = allYearsForPercentage.map((year, index) => {
            return Object.values(chartData).reduce((sum, dataset) => {
                const dataValue = dataset[index] || (index === allYearsForPercentage.length - 1 ? dataset[dataset.length - 1] : 0);
                return sum + (dataValue || 0);
            }, 0);
        });

        const percentageData = {};
        Object.keys(chartData).forEach(key => {
            percentageData[key] = allYearsForPercentage.map((year, index) => {
                const dataset = chartData[key];
                const dataValue = dataset[index] || (index === allYearsForPercentage.length - 1 ? dataset[dataset.length - 1] : 0);
                const total = yearlyTotals[index];
                return total > 0 ? (dataValue / total) * 100 : 0;
            });
        });

        const barDatasets = Object.keys(percentageData).map((key, idx) => ({
            label: key,
            data: percentageData[key],
            backgroundColor: colors[idx % colors.length],
            hoverBackgroundColor: colors[idx % colors.length],
            borderColor: '#ffffff',
            borderWidth: 1,
            barThickness: 26,
            borderRadius: 6
        }));

        const insideLabelsPlugin = {
            id: 'insideLabels',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                ctx.save();

                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);

                    meta.data.forEach((bar, index) => {
                        const value = dataset.data[index];
                        if (!value || value < 5) return;

                        let centerX = bar.x;
                        const segmentWidth = bar.width;
                        
                        if (datasetIndex === 0) {
                            centerX = bar.x / 2;
                        } else {
                            let previousWidth = 0;
                            for (let i = 0; i < datasetIndex; i++) {
                                const prevMeta = chart.getDatasetMeta(i);
                                const prevBar = prevMeta.data[index];
                                previousWidth += prevBar.width;
                            }
                            centerX = previousWidth + (segmentWidth / 2);
                        }

                        const centerY = bar.y;
                        const text = value.toFixed(0) + '%';

                        ctx.font = 'bold 11px Arial';
                        ctx.fillStyle = '#ffffff';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        const padding = 4;
                        const textWidth = ctx.measureText(text).width;

                        ctx.fillStyle = 'rgba(0,0,0,0.35)';
                        ctx.fillRect(
                            centerX - textWidth / 2 - padding,
                            centerY - 8,
                            textWidth + padding * 2,
                            16
                        );
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(text, centerX, centerY);
                    });
                });
                ctx.restore();
            }
        };

        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: allYearsForPercentage,
                datasets: barDatasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribusi Permintaan per Tahun (%) - Termasuk Prediksi ' + nextYear,
                        font: { size: 16, weight: 'bold' },
                        color: '#f0f6fc'
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10,
                            font: { size: 12 },
                            color: '#8b949e'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        axis: 'y',  
                        backgroundColor: '#21262d',
                        titleColor: '#f0f6fc',
                        bodyColor: '#f0f6fc',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        callbacks: {
                            title: function(tooltipItems) {
                                const dataIndex = tooltipItems[0].dataIndex;
                                const year = allYearsForPercentage[dataIndex];
                                const isPrediction = dataIndex === allYearsForPercentage.length - 1;
                                return isPrediction ? `Prediksi ${year}` : `Tahun ${year}`;
                            },
                            label: function(context) {
                                const label = context.dataset.label;
                                const percent = context.parsed.x.toFixed(1);
                                const yearIndex = context.dataIndex;
                                
                                const dataset = chartData[label];
                                let originalValue = dataset[yearIndex];
                                if (yearIndex === allYearsForPercentage.length - 1) {
                                    originalValue = dataset[dataset.length - 1];
                                }
                                
                                const isPrediction = yearIndex === allYearsForPercentage.length - 1;
                                const suffix = isPrediction ? ' (Prediksi)' : '';
                                return `${label}: ${percent}% (${originalValue.toLocaleString('id-ID')} unit${suffix})`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%',
                            color: '#8b949e'
                        },
                        title: {
                            display: true,
                            text: 'Persentase',
                            color: '#8b949e'
                        },
                        grid: { 
                            color: '#30363d',
                            drawBorder: false
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Tahun',
                            color: '#8b949e'
                        },
                        grid: { 
                            display: false,
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#8b949e',
                            padding: 10
                        }
                    }
                }
            },
            plugins: [insideLabelsPlugin]
        });
    } catch (err) {
        console.error("Chart error:", err);
    }
});
        </script>
        <script>
            
// =========================================================
// âœ… PDF WITH DJANGO TEMPLATE DATA - NO DOM SCRAPING
// =========================================================

function generatePDFWithData() {
    console.log('Starting PDF with template data...');
    
    const btn = document.getElementById('downloadPdf');
    const originalHTML = btn.innerHTML;
    
    // Loading state
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Memproses...';
    btn.disabled = true;
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            let yPosition = 20;
            const margin = 15;
            const pageWidth = pdf.internal.pageSize.width;
            const pageHeight = pdf.internal.pageSize.height;
            
            // ===== HEADER =====
            pdf.setFontSize(18);
            pdf.setTextColor(0, 0, 128);
            pdf.text('LAPORAN HASIL PERAMALAN JAS ALMAMATER', pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 8;
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Dibuat pada: ${new Date().toLocaleDateString('id-ID')}`, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            
            // ===== SUMMARY =====
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.text('RINGKASAN HASIL', margin, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.text(`â€¢ Total Ukuran: {{ results|length }}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ MAPE Terbaik: {{ best_mape }}%`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ Tahun Prediksi: {{ results.0.tahun_next }}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`â€¢ Total Perhitungan: {{ total_calculations }} kombinasi`, margin, yPosition);
            yPosition += 15;
            
            // ===== TABLE 1: MAPE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 100, 0);
            pdf.text('HASIL PREDIKSI - MAPE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(0, 100, 0);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Aktual', margin + 100, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
            pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data - Using Django template data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha_mape }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.actual_last }}', margin + 100, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 10;
            
            // ===== TABLE 2: MAE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 150);
            pdf.text('HASIL PREDIKSI - MAE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(0, 0, 150);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Aktual', margin + 100, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
            pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in mae_best_results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.actual_last }}', margin + 100, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 10;
            
            // ===== TABLE 3: MSE TERBAIK =====
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(12);
            pdf.setTextColor(150, 100, 0);
            pdf.text('HASIL PREDIKSI - MSE TERBAIK', margin, yPosition);
            yPosition += 8;
            
            // Table Header
            pdf.setFillColor(150, 100, 0);
            pdf.setTextColor(255, 255, 255);
            pdf.rect(margin, yPosition, pageWidth - 2 * margin, 6, 'F');
            
            pdf.setFontSize(8);
            pdf.text('Ukuran', margin + 2, yPosition + 4);
            pdf.text('Alpha', margin + 25, yPosition + 4);
            pdf.text('MAPE%', margin + 40, yPosition + 4);
            pdf.text('MAE', margin + 60, yPosition + 4);
            pdf.text('MSE', margin + 80, yPosition + 4);
            pdf.text('Aktual', margin + 100, yPosition + 4);
            pdf.text('Forecast', margin + 120, yPosition + 4);
            pdf.text('Trend', margin + 150, yPosition + 4);
            
            yPosition += 8;
            
            // Table Data
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            {% for r in mse_best_results %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.text('{{ r.ukuran }}', margin + 2, yPosition);
            pdf.text('{{ r.alpha }}', margin + 25, yPosition);
            pdf.text('{{ r.mape }}%', margin + 40, yPosition);
            pdf.text('{{ r.mae }}', margin + 60, yPosition);
            pdf.text('{{ r.mse }}', margin + 80, yPosition);
            pdf.text('{{ r.actual_last }}', margin + 100, yPosition);
            pdf.text('{{ r.forecast_next }}', margin + 120, yPosition);
            pdf.text('{{ r.forecast_trend }}', margin + 150, yPosition);
            
            yPosition += 5;
            {% endfor %}
            
            yPosition += 15;
            
            // ===== ALL ALPHA COMPARISON =====
            {% for ukuran, calculations in all_calculations.items %}
            if (yPosition > pageHeight - 50) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`PERBANDINGAN SEMUA ALPHA - {{ ukuran }}`, margin, yPosition);
            yPosition += 6;
            
            // Sub-header
            pdf.setFontSize(7);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Alpha', margin + 2, yPosition);
            pdf.text('MAPE%', margin + 15, yPosition);
            pdf.text('MAE', margin + 30, yPosition);
            pdf.text('MSE', margin + 45, yPosition);
            pdf.text('Forecast', margin + 60, yPosition);
            
            yPosition += 4;
            
            {% for calc in calculations %}
            if (yPosition > pageHeight - 10) {
                pdf.addPage();
                yPosition = margin;
            }
            
            pdf.setFontSize(7);
            pdf.setTextColor(0, 0, 0);
            
            pdf.text('{{ calc.alpha }}', margin + 2, yPosition);
            pdf.text('{{ calc.mape }}%', margin + 15, yPosition);
            pdf.text('{{ calc.mae }}', margin + 30, yPosition);
            pdf.text('{{ calc.mse }}', margin + 45, yPosition);
            pdf.text('{{ calc.forecast_next }}', margin + 60, yPosition);
            
            yPosition += 4;
            {% endfor %}
            
            yPosition += 8;
            {% endfor %}
            
            // ===== FOOTER =====
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }
            
            // Save PDF
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            pdf.save(`Laporan-Peramalan-${timestamp}.pdf`);
            
            console.log('PDF dengan data template berhasil dibuat!');
            
        } catch (error) {
            console.error('Error creating PDF:', error);
            alert('Gagal membuat PDF: ' + error.message);
        } finally {
            // Restore button
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }, 100);
}

// =========================================================
// ðŸŽ¯ SIMPLE EVENT HANDLER
// =========================================================

function initializePDF() {
    const btn = document.getElementById('downloadPdf');
    if (btn) {
        // Remove any existing listeners
        btn.replaceWith(btn.cloneNode(true));
        
        // Get new reference
        const newBtn = document.getElementById('downloadPdf');
        
        // Add click handler
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            generatePDFWithData();
        });
        
        console.log('PDF button initialized successfully');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializePDF);

// Backup initialization
setTimeout(initializePDF, 500);
        </script>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </body>
    </html>